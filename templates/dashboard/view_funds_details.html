<!DOCTYPE html>
{% extends 'dashboard/base_dashboard.html' %}
{% load static %} <!-- 添加static标签加载 -->
{% load myfilters%}
{% load humanize %}

{% block extra_css %}
    <!-- 引用外部CSS文件 -->
    <link href="{% static 'stock/css/calendar.css' %}" rel="stylesheet">
    <link href="{% static 'stock/css/card.css' %}" rel="stylesheet">
{% endblock %}


{% block page_content %}
    <style>
        /*
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            border: none;
            margin-bottom: 30px;
        }

        .card-header {
            background: linear-gradient(135deg, #1e5799, #207cca);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: none;
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        .btn-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-toggle.active {
            background: white;
            color: #1e5799;
            font-weight: 500;
        }

        .btn-toggle:hover:not(.active) {
            background: rgba(255, 255, 255, 0.3);
        }

        .card-body {
            padding: 25px;
        }
         */

        .chart-container {
            height: 450px;
        }

        /*
        #yearly-InOut-chart {
            width: 100%;
            height: 100%;
        }

        #yearly-Profit-chart {
            width: 100%;
            height: 100%;
        }
        */

        .table-container {
            display: none;
            overflow: auto;
            max-height: 450px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table th {
            background-color: #1e5799;
            color: white;
            padding: 12px 15px;
            text-align: left;
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eaeef5;
        }

        .data-table tr:nth-child(even) {
            background-color: #f9fafc;
        }

        .data-table tr:hover {
            background-color: #f0f7ff;
        }

        .positive {
            color: #2c9f5c;
            font-weight: 500;
        }

        .negative {
            color: #c84f4f;
            font-weight: 500;
        }

        /*
        .card-footer {
            background-color: #f9fafc;
            color: #7a869a;
            font-size: 14px;
            padding: 15px 20px;
            border-top: 1px solid #eaeef5;
            display: flex;
            justify-content: space-between;
        }
         */

        @media (max-width: 768px) {
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .btn-group {
                align-self: stretch;
                justify-content: space-between;
            }

            .btn-toggle {
                flex: 1;
                text-align: center;
            }

            .chart-container, .table-container {
                height: 400px;
            }
        }
    </style>


    <div class="container-fluid">
        <!-- Page Heading -->
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <div class="col-xl-4" style="text-align:left">
                <h1 class="h3 mb-0 font-weight-bold text-gray-700">{{ funds_name }}</h1>
            </div>
            <div class="col-xl-4" style="text-align:center">
                <form action="" method="post" class="form-horizontal" role="form">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-primary"><i class="fas fa-sync-alt"></i>&nbsp&nbsp{{ baseline.modified_time }}</button>
                </form>
            </div>
            <div class="col-xl-4" style="text-align:right">
                <div class="col-auto">
                    <div class="h6 mb-0 text-gray-500">
                        <a href="javascript:history.back()" style="color: inherit; text-decoration: none;">返回 ></a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Card Row -->
        <div class="row">
            <!-- 概要 -->
            <div class="col-xl-6 col-md-6 mb-4">
                <div class="card h-100 shadow mb-4">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between" style="height: 60px;">
                        <h6 class="m-0 font-weight-bold text-primary">概要</h6>
                        <div class="h6 mb-0 text-gray-500" style="font-size: 1.0em;">
                            <a href="/benben/add_funds_details/{{ funds_id|safe }}/" style="color: inherit; text-decoration: none;">记一笔 ></a>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Card Body - 总资产概览 -->
                        <div class="metric-group">
                            <div class="row g-4">
                                <div class="col-md-3">
                                    <div class="metric-label">总资产</div>
                                    <div class="metric-value">
                                        <span>{{ current_funds_details_object.funds_value|floatformat:0 }}</span>
                                        <span class="metric-unit">元</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-label">本金</div>
                                    <div class="metric-value">
                                        <span>{{ current_funds_details_object.funds_principal|floatformat:0 }}</span>
                                        <span class="metric-unit">元</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-label">收益</div>
                                    <div class="metric-value">
                                        <span>{{ current_funds_details_object.funds_profit|value_display:"number" }}</span>
                                        <span class="metric-unit">元</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-label">收益率</div>
                                    <div class="metric-value">
                                        <span>{{ profit_rate|value_display:"percent" }}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Card Body - 收益周期对比 -->
                        <div class="metric-group">
    {#                        <div class="metric-group-title">本期收益</div>#}
                            <div class="row g-4">
                                <div class="col-md-3">
    {#                                <div class="metric-date">{{ second_max_date|date:'y/m/d' }}</div>#}
                                    <div class="metric-label">上期资产（<span class="metric-date">{{ second_max_date|date:'y/m/d' }}</span>）</div>
                                    <div class="metric-value">
                                        <span>{{ last_period_value|floatformat:0 }}</span>
                                        <span class="metric-unit">元</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
    {#                                <div class="metric-date">{{ max_date|date:'y/m/d' }}</div>#}
                                    <div class="metric-label">当期资产（<span class="metric-date">{{ max_date|date:'y/m/d' }}</span>）</div>
                                    <div class="metric-value">
                                        <span>{{ current_funds_details_object.funds_value|floatformat:0 }}</span>
                                        <span class="metric-unit">元</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
    {#                                <div class="metric-date">{{ second_max_date|date:'y/m/d' }}~{{ max_date|date:'y/m/d' }}</div>#}
                                    <div class="metric-label">当期收益</div>
                                    <div class="metric-value">
                                        <span>{{ current_funds_details_object.funds_current_profit|value_display:"number" }}</span>
                                        <span class="metric-unit">元</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
    {#                                <div class="metric-date">{{ second_max_date|date:'y/m/d' }}~{{ max_date|date:'y/m/d' }}</div>#}
                                    <div class="metric-label">当期收益率</div>
                                    <div class="metric-value">
                                        <span>{{ current_funds_details_object.funds_current_profit_rate|value_display:"percent" }}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Card Body - 年度表现 -->
                        <div class="metric-group">
    {#                        <div class="metric-group-title">年度表现</div>#}
                            <div class="row g-4">
                                <div class="col-md-3">
                                    <div class="metric-label">上年资产</div>
                                    <div class="metric-value">
                                        <span>{{ last_year_value|floatformat:0 }}</span>
                                        <span class="metric-unit">元</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-label">当年资产</div>
                                    <div class="metric-value">
                                        <span>{{ current_funds_details_object.funds_value|floatformat:0 }}</span>
                                        <span class="metric-unit">元</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-label">年内收益</div>
                                    <div class="metric-value">
                                        <span>{{ year_change_amount|value_display:"number" }}</span>
                                        <span class="metric-unit">元</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-label">年内收益率</div>
                                    <div class="metric-value">
                                        <span>{{ year_change_rate|value_display:"percent" }}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Card Body - 综合指标 -->
                        <div class="metric-group">
    {#                        <div class="metric-group-title">综合指标</div>#}
                            <div class="row g-4">
                                <div class="col-md-3">
                                    <div class="metric-label">净值</div>
                                    <div class="metric-value">
                                        <span>{{ current_funds_details_object.funds_net_value|floatformat:4 }}</span>
                                        <span class="metric-unit">元</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-label">投资时长</div>
                                    <div class="metric-value">
                                        <span>{{ years|floatformat:0 }}</span>
                                        <span class="metric-unit">年</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-label">年内加权收益率</div>
                                    <div class="metric-value">
                                        <span>{{ year_change_net_value_rate|value_display:"percent" }}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-label">年化收益率</div>
                                    <div class="metric-value">
                                        <span>{{ current_funds_details_object.funds_annualized_profit_rate|value_display:"percent" }}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        数据更新于：{{ updating_time|date:'Y-m-d H:i:s' }}
                    </div>
                </div>
            </div>

            <!-- 净值曲线 -->
            <div class="col-xl-6 col-md-6 mb-4">
                <div class="card h-100 shadow mb-4">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between" style="height: 60px;">
                        <h6 class="m-0 font-weight-bold text-primary">净值曲线</h6>
                        <div class="btn-group" id="netvalueChartSwitch">
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary"
                                data-range="currentYear"
                                style="font-size: 12px !important; padding: 0.25rem 0.75rem;"
                            >今年</button>
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary"
                                data-range="month"
                                style="font-size: 12px !important; padding: 0.25rem 0.75rem;"
                            >近一月</button>
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary active"
                                data-range="year"
                                style="font-size: 12px !important; padding: 0.25rem 0.75rem;"
                            >近一年</button>
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary"
                                data-range="all"
                                style="font-size: 12px !important; padding: 0.25rem 0.75rem;"
                            >全部</button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="container mt-4">
                            <div id="netvalueChart" style="width:100%; height:380px;"></div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <span>数据更新于：{{ updating_time|date:'Y-m-d H:i:s' }}</span>
                        <span>注：净值单位为元。</span>
                    </div>
                </div>
            </div>

        </div>

        <div class="row">
            <!-- 资产曲线 -->
            <div class="col-xl-6 col-md-6 mb-4">
                <div class="card h-100 shadow mb-4">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between" style="height: 60px;">
                        <h6 class="m-0 font-weight-bold text-primary">资产曲线</h6>
                        <div class="btn-group" id="valueChartSwitch">
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary active"
                                data-range="currentYear"
                                style="font-size: 12px !important; padding: 0.25rem 0.75rem;"
                            >今年</button>
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary"
                                data-range="month"
                                style="font-size: 12px !important; padding: 0.25rem 0.75rem;"
                            >近一月</button>
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary"
                                data-range="year"
                                style="font-size: 12px !important; padding: 0.25rem 0.75rem;"
                            >近一年</button>
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary"
                                data-range="all"
                                style="font-size: 12px !important; padding: 0.25rem 0.75rem;"
                            >全部</button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="container mt-4">
                            <div id="valueChart" style="width:100%; height:400px;"></div>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-muted small d-flex justify-content-between">
                        <span>数据更新于：{{ updating_time|date:'Y-m-d H:i:s' }}</span>
                        <span>注：资产单位为万元。</span>
                    </div>
                </div>
            </div>

            <!-- 收益曲线 -->
            <div class="col-xl-6 col-md-6 mb-4">
                <div class="card h-100 shadow mb-4">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between" style="height: 60px;">
                        <h6 class="m-0 font-weight-bold text-primary">收益曲线</h6>
                        <div class="btn-group" id="profitChartSwitch">
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary active"
                                data-range="currentYear"
                                style="font-size: 12px !important; padding: 0.25rem 0.75rem;"
                            >今年</button>
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary"
                                data-range="month"
                                style="font-size: 12px !important; padding: 0.25rem 0.75rem;"
                            >近一月</button>
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary"
                                data-range="year"
                                style="font-size: 12px !important; padding: 0.25rem 0.75rem;"
                            >近一年</button>
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary"
                                data-range="all"
                                style="font-size: 12px !important; padding: 0.25rem 0.75rem;"
                            >全部</button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="container mt-4">
                            <div id="profitChart" style="width:100%; height:400px;"></div>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-muted small d-flex justify-content-between">
                        <span>数据更新于：{{ updating_time|date:'Y-m-d H:i:s' }}</span>
                        <span>注：收益单位为万元。</span>
                    </div>
                </div>
            </div>

        </div>

        <div class="row">
            <!-- 收益日历 -->
            <div class="col-xl-6 col-md-6 mb-4">
                <div class="card h-100 shadow mb-4">
                    <!-- Card Header - Dropdown -->
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between" style="height: 60px;">
                        <h6 class="m-0 font-weight-bold text-primary">收益日历</h6>
                    </div>
                    <!-- Card Body -->
                    <div class="card-body">
                        <!-- 标题和按钮区域 -->
                        <div class="row align-items-center mb-4">
                            <div class="col-auto pr-0">
                                <!-- 年月视图切换按钮 -->
                                <div class="btn-group" id="viewSwitch">
                                    <button
                                        class="btn btn-outline-primary active"
                                        data-type="month"
                                        style="font-size: 14px !important; padding: 0.25rem 0.75rem;"
                                    >月</button>
                                    <button
                                        class="btn btn-outline-primary"
                                        data-type="year"
                                        style="font-size: 14px !important; padding: 0.25rem 0.75rem;"
                                    >年</button>
                                </div>
                            </div>
                            <div class="col d-flex justify-content-end">
                                <!-- 时间显示和按钮 -->
                                <div class="d-flex align-items-center">
                                    <button class="btn" id="prevBtn">
                                        <i class="fas fa-chevron-left"></i> <!-- 字体图标 -->
                                    </button>
                                    <div class="flex-grow-1 text-center px-1">
                                        <span id="timeDisplay"></span>
                                    </div>
                                    <button class="btn" id="nextBtn">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- 星期头 -->
                        <div class="week-days" id="weekHeader">
                            <div class="week-day">一</div>
                            <div class="week-day">二</div>
                            <div class="week-day">三</div>
                            <div class="week-day">四</div>
                            <div class="week-day">五</div>
                        </div>
                        <!-- 日期网格 -->
                        <div class="date-grid" id="calendarGrid"></div>
                        <!-- 摘要信息 -->
                        <div class="summary" id="periodSummary"></div>
                    </div>
                    <div class="card-footer bg-white text-muted small">
                        数据更新于：{{ updating_time|date:'Y-m-d H:i:s' }}
                    </div>
                </div>
            </div>

            <!-- 资产、收益、出入金列表 -->
            <div class="col-xl-6 col-lg-6 d-flex">
                <div class="card shadow mb-4 w-100 d-flex flex-column">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between" style="height: 60px;">
                        <h6 class="m-0 font-weight-bold text-primary" id="dataListTitle">出入金列表</h6>
                        <div class="btn-group" id="dataListSwitch">
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary active"
                                data-range="fund"
                                style="font-size: 12px !important; padding: 0.25rem 0.75rem;"
                            >资产</button>
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary"
                                data-range="profit"
                                style="font-size: 12px !important; padding: 0.25rem 0.75rem;"
                            >收益</button>
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary"
                                data-range="inout"
                                style="font-size: 12px !important; padding: 0.25rem 0.75rem;"
                            >出入金</button>
                        </div>
                    </div>
                    <div class="card-body" style="position: relative; flex-grow: 1; min-height: 0;">
                        <div class="scroll-area">
                            <!-- 近期出入金表格 -->
                            <div id="fundTable" class="h-100" style="display:block; overflow-y:auto;">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-condensed table-striped table-hover list_tab" style="margin-bottom:0;">
                                        <thead class="bg-gradient-secondary text-gray-100">
                                            <tr>
                                                <th>日期</th>
                                                <th>基金价值</th>
                                                <th>出入金</th>
                                                <th>基金净值</th>
                                                <th>当期收益</th>
                                                <th>当期收益率</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for funds_details in funds_details_list_TOP %}
                                                <tr>
                                                    <td>{{ funds_details.date|date:'Y-m-d' }}</td>
                                                    <td>{{ funds_details.funds_value|floatformat:0 }}</td>
                                                    <td style="color: {{ funds_details.funds_in_out|text_color }}">{{ funds_details.funds_in_out|floatformat:0 }}</td>
                                                    <td>{{ funds_details.funds_net_value|floatformat:4 }}</td>
                                                    <td style="color: {{ funds_details.funds_current_profit|text_color }}">{{ funds_details.funds_current_profit|floatformat:0 }}</td>
                                                    <td style="color: {{ funds_details.funds_current_profit_rate|text_color }}">{{ funds_details.funds_current_profit_rate|percent }}%</td>
                                                </tr>
                                            {% empty %}
                                                <tr>
                                                    <td colspan="9">无相关记录！</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- 年度出入金表格 -->
                            <div id="profitTable" class="h-100" style="display:none; overflow-y:auto;">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-condensed table-striped table-hover list_tab" style="margin-bottom:0;">
                                        <thead class="bg-gradient-secondary text-gray-100">
                                            <tr>
                                                <th>日期</th>
                                                <th>当期收益</th>
                                                <th>当期收益率</th>
                                                <th>累计收益</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in funds_details_list_TOP %}
                                                <tr>
                                                    <td>{{ item.date|date:'Y-m-d' }}</td>
                                                    <td style="color: {{ item.funds_current_profit|text_color }}">{{ item.funds_current_profit|floatformat:0 }}</td>
                                                    <td style="color: {{ item.funds_current_profit_rate|text_color }}">{{ item.funds_current_profit_rate|percent }}%</td>
                                                    <td style="color: {{ item.funds_profit|text_color }}">{{ item.funds_profit|floatformat:0 }}</td>
                                                </tr>
                                            {% empty %}
                                                <tr>
                                                    <td colspan="3">无相关记录！</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>


                            <!-- 全部出入金表格 -->
                            <div id="inoutTable" class="h-100" style="display:none; overflow-y:auto;">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-condensed table-striped table-hover list_tab" style="margin-bottom:0;">
                                        <thead class="bg-gradient-secondary text-gray-100">
                                            <tr>
                                                <th>日期</th>
                                                <th>出入金</th>
                                                <th>基金净值</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in recent_in_out_list %}
                                                <tr>
                                                    <td>{{ item.date|date:'Y-m-d' }}</td>
                                                    <td style="color: {{ item.funds_in_out|text_color }}">{{ item.funds_in_out|floatformat:0 }}</td>
                                                    <td>{{ item.funds_net_value|floatformat:4 }}</td>
                                                </tr>
                                            {% empty %}
                                                <tr>
                                                    <td colspan="3">无相关记录！</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-muted small d-flex justify-content-between">
                        数据更新于：{{ updating_time|date:'Y-m-d H:i:s' }}
                        <span></span>
                    </div>
                </div>
            </div>

        </div>

        <div class="row">
            <!-- 年度收益柱图及列表 -->
            <div class="col-xl-6 col-md-6 mb-4">
                <div class="card">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between" style="height: 60px;">
                        <h6 class="m-0 font-weight-bold text-primary">年度收益统计</h6>
                        <div class="btn-group" id="view-toggle-Profit">
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary btn-toggle active"
                                style="font-size: 12px !important; padding: 0.25rem 0.75rem;"
                                data-view="chart"
                            >图表视图</button>
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary btn-toggle"
                                style="font-size: 12px !important; padding: 0.25rem 0.75rem;"
                                data-view="table"
                            >列表视图</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" id="chart-container-Profit">
                            <div id="yearly-Profit-chart" style="width:100%; height:100%;"></div>
                        </div>
                        <div class="table-container" id="table-container-Profit">
                            <div class="table-responsive">
                                <table class="table table-bordered table-condensed table-striped table-hover list_tab" style="margin-bottom:0;">
                                    <thead class="bg-gradient-secondary text-gray-100">
                                        <tr>
                                            <th>年份</th>
                                            <th>收益</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for entry in yearly_profit_list %}
                                            <tr>
                                                <td>{{ entry.date__year|stringformat:"s" }}年</td>
                                                <td style="color: {{ entry.yearly_profit|text_color }}">{{ entry.yearly_profit|floatformat:0 }}</td>
                                            </tr>
                                        {% empty %}
                                            <tr>
                                                <td colspan="3">无相关记录！</td>
                                            </tr>
                                        {% endfor %}
                                            <tr>
                                                <td>总计</td>
                                                <td>{{ profit_total|floatformat:0 }}</td>
                                            </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-muted small d-flex justify-content-between">
                        <span>数据更新于：{{ updating_time|date:'Y-m-d H:i:s' }}</span>
                        <span>注：单位为万元。</span>
                    </div>
                </div>
            </div>

            <!-- 年度出入金柱图及列表 -->
            <div class="col-xl-6 col-md-6 mb-4">
                <div class="card">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between" style="height: 60px;">
                        <h6 class="m-0 font-weight-bold text-primary">年度出入金统计</h6>
                        <div class="btn-group" id="view-toggle-InOut">
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary btn-toggle active"
                                style="font-size: 12px !important; padding: 0.25rem 0.75rem;"
                                data-view="chart"
                            >图表视图</button>
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary btn-toggle"
                                style="font-size: 12px !important; padding: 0.25rem 0.75rem;"
                                data-view="table"
                            >列表视图</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" id="chart-container-InOut">
                            <div id="yearly-InOut-chart" style="width:100%; height:100%;"></div>
                        </div>
                        <div class="table-container" id="table-container-InOut">
                            <div class="table-responsive">
                                <table class="table table-bordered table-condensed table-striped table-hover list_tab" style="margin-bottom:0;">
                                    <thead class="bg-gradient-secondary text-gray-100">
                                        <tr>
                                            <th>年份</th>
                                            <th>出入金</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for entry in yearly_in_out_list %}
                                            <tr>
                                                <td>{{ entry.date__year|stringformat:"s" }}年</td>
                                                <td style="color: {{ entry.yearly_in_out|text_color }}">{{ entry.yearly_in_out|floatformat:0 }}</td>
                                            </tr>
                                        {% empty %}
                                            <tr>
                                                <td colspan="3">无相关记录！</td>
                                            </tr>
                                        {% endfor %}
                                            <tr>
                                                <td>总计</td>
                                                <td>{{ in_out_total|floatformat:0 }}</td>
                                            </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-muted small d-flex justify-content-between">
                        <span>数据更新于：{{ updating_time|date:'Y-m-d H:i:s' }}</span>
                        <span>注：单位为万元。</span>
                    </div>
                </div>
            </div>

        </div>


        <div class="row">
            <!-- 年度收益率 -->
            <div class="col-xl-6 col-md-6 mb-4">
                <div class="card h-100 shadow mb-4">
                    <!-- Card Header - Dropdown -->
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between" style="height: 60px;">
                        <h6 class="m-0 font-weight-bold text-primary">年度收益率</h6>
                    </div>
                    <!-- Card Body -->
                    <div class="card-body">
                        <div id="bar_net_value" style="width:100%; height:400px;"></div><!--数据展现的容器1-->
                    </div>
                    <div class="card-footer bg-white text-muted small">
                        数据更新于：{{ updating_time|date:'Y-m-d H:i:s' }}
                    </div>
                </div>
            </div>

            <!-- 年化收益率曲线 -->
            <div class="col-xl-6 col-md-6 mb-4">
                <div class="card h-100 shadow mb-4">
                    <!-- Card Header - Dropdown -->
                    <div
                        class="card-header py-3 d-flex flex-row align-items-center justify-content-between" style="height: 60px;">
                        <h6 class="m-0 font-weight-bold text-primary">年化收益率曲线</h6>
                    </div>
                    <!-- Card Body -->
                    <div class="card-body">
                        <div id="line_annualized_profit_rate" style="width:100%; height:400px; display:block;"></div>
                    </div>
                    <div class="card-footer bg-white text-muted small d-flex justify-content-between">
                        <span>数据更新于：{{ updating_time|date:'Y-m-d H:i:s' }}</span>
                        <span>注：年化收益率为期初至各年份的年化收益率。</span>
                    </div>
                </div>
            </div>

        </div>

        <!-- 收益率对比 -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between" style="height: 60px;">
                <h6 class="m-0 font-weight-bold text-primary">收益率对比</h6>
            </div>
            <!-- Card Body -->
            <div class="card-body">
                <div style="height:100%; width:100%; display:block; overflow-y:auto;" class="scrollDiv">
                    <div class="table-responsive">
                        <!--<table id="dataTable_profit" class="table table-bordered table-condensed table-striped table-hover list_tab" style="margin-bottom:0px;">-->
                        <table class="table table-bordered table-condensed table-striped table-hover list_tab" style="margin-bottom:0;">
                            <thead class="bg-gradient-secondary text-gray-100">
                                <tr style="margin-bottom:0;">
                                    <th rowspan="2">年份</th>
                                    <th colspan="2">基金价值</th>
                                    <th colspan="3">净值</th>
                                    <th colspan="3">当年收益率（%）</th>
                                    <th colspan="3">年化收益率（%）</th>
                                    <th colspan="3">连续三年年化收益率（%）</th>
                                    <th colspan="3">连续五年年化收益率（%）</th>
                                </tr>
                                <tr class="border border-top-0">
                                    <th>{{ funds_name }}</th>
                                    <th>{{ baseline_name }}</th>
                                    <th>{{ funds_name }}</th>
                                    <th>{{ baseline_name }}</th>
                                    <th>对比 （%）</th>
                                    <th>{{ funds_name }}</th>
                                    <th>{{ baseline_name }}</th>
                                    <th>对比</th>
                                    <th>{{ funds_name }}</th>
                                    <th>{{ baseline_name }}</th>
                                    <th>对比</th>
                                    <th>{{ funds_name }}</th>
                                    <th>{{ baseline_name }}</th>
                                    <th>对比</th>
                                    <th>{{ funds_name }}</th>
                                    <th>{{ baseline_name }}</th>
                                    <th>对比</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in compare_data_group %}
                                    <tr>
                                        {% for value in item %}
                                            {% if forloop.counter0 == 0 %}
                                                <td>{{ value }}</td>
                                            {% elif forloop.counter0 == 1 %}
                                                <td>{{ value|floatformat:0 }}</td>
                                            {% elif forloop.counter0 == 2 %}
                                                <td>{{ value|floatformat:2 }}</td>
                                            {% elif forloop.counter0 < 5 %}
                                                <td>{{ value|floatformat:4 }}</td>
                                            {% else %}
                                                <td style="color: {{ value|text_color }}">{{ value|intcomma|floatformat:2 }}</td>
                                            {% endif %}
                                        {% endfor %}
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="18">无相关记录！</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-white text-muted small">
                数据更新于：{{ updating_time|date:'Y-m-d H:i:s' }}
            </div>
        </div>
    </div>

    <script>
    'use strict';

    // 净值曲线
    document.addEventListener('DOMContentLoaded', function() {
        const chart = echarts.init(document.getElementById('netvalueChart'));
        const allData = {{ fund_data|safe }};
        // let currentRange = 'currentYear';
        let currentRange = 'year';

        // 时间范围计算
        function getDateRange(range) {
            const now = new Date();
            const ranges = {
                all: new Date(0),
                year: new Date(now.getFullYear() - 1, now.getMonth(), now.getDate()),
                month: (() => {
                    const currentYear = now.getFullYear();
                    const currentMonth = now.getMonth();
                    const currentDay = now.getDate();

                    // 计算目标月份和年份
                    let targetYear, targetMonth;
                    if (currentMonth === 0) {
                        targetYear = currentYear - 1;
                        targetMonth = 11; // 12月
                    } else {
                        targetYear = currentYear;
                        targetMonth = currentMonth - 1; // 上月
                    }

                    // 获取目标月份的最后一天
                    const lastDayOfTargetMonth = new Date(targetYear, targetMonth + 1, 0).getDate();

                    // 判断是否需要调整日期
                    if (currentDay > lastDayOfTargetMonth) {
                        // 超出则设为当前月份的第一天
                        return new Date(currentYear, currentMonth, 1);
                    } else {
                        // 未超出则保持目标月份的对应日期
                        return new Date(targetYear, targetMonth, currentDay);
                    }
                })(),
                currentYear: new Date(now.getFullYear(), 0, 1)
            };
            return ranges[range] || ranges.all;
        }

        // 更新图表
        function updateChart(range) {
            const startDate = getDateRange(range);
            const filteredData = allData.filter(d => new Date(d.date) >= startDate);
            const option = {
                legend: {
                    data: ['净值'],
                    top: 0, // 放在图表底部
                    //icon: 'circle', // 使用圆形图标
                    //itemWidth: 10,
                    //itemHeight: 10
                },
                grid: {
                    left: '2%',    // 调整为更小的值
                    right: '2%',
                    top: '2%',
                    bottom: '0%',
                    containLabel: true
                },
                xAxis: {
                    type: 'time',
                    axisLabel: {
                        rotate: 45,
                        margin: 15,
                        interval: (index, timestamp) => {
                            const axis = chart.getModel().getComponent('xAxis', 0).axis;
                            const [min, max] = axis.scale.getExtent();
                            const totalDays = (max - min) / (1000 * 3600 * 24);

                            if (totalDays <= 7) return index % 1 === 0;
                            if (totalDays <= 30) return index % 2 === 0;
                            return index % Math.ceil(totalDays/30) === 0;
                        },
                        formatter: function (value) {
                            const date = new Date(value);
                            // 处理闰年2月29日
                            if (date.getMonth() === 1 && date.getDate() === 29) {
                                return '02-29';
                            }
                            const rangeType = range;

                            if (rangeType === 'currentYear' || rangeType === 'month') {
                                const axis = chart.getModel().getComponent('xAxis', 0).axis;
                                const [min, max] = axis.scale.getExtent();
                                const dayDiff = (max - min) / (1000 * 3600 * 24);

                                // 精确判断逻辑
                                if (dayDiff <= 60) { // 调整为60天阈值
                                    const month = (date.getMonth()+1).toString().padStart(2, '0');
                                    const day = date.getDate().toString().padStart(2, '0');
                                    return `${month}-${day}`;
                                }
                                //return `${date.getFullYear().slice(-2)}-${(date.getMonth()+1).toString().padStart(2, '0')}`;
                                return `${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                            }

                            if (rangeType === 'all') {
                                return `${date.getFullYear()}`;
                            }
                            return `${date.getFullYear().toString().slice(-2)}-${(date.getMonth()+1).toString().padStart(2, '0')}`;
                        }
                    },
                    axisTick: {
                        alignWithLabel: true
                    }
                },
                yAxis: {
                    type: 'value',
                    min: 'dataMin',
                    axisLabel: {
                        formatter: value => value.toFixed(2)
                    }
                },
                series: [
                    {
                        name: '净值',
                        data: filteredData.map(d => [
                            new Date(d.date).getTime(), // 转换为时间戳
                            d.net_value
                        ]),
                        /*
                        markPoint: {
                             // 根据条件生成数据数组（核心逻辑）
                            data: (range === 'all') ? [
                                { type: 'max', symbol: 'circle', symbolSize: 5, itemStyle: { color: 'orange' }},
                                { type: 'min', symbol: 'circle', symbolSize: 5, itemStyle: { color: 'orange' } }
                            ] : [],
                            //label: { show: false } // 显示标签及数值
                            label: {
                                show: false,
                                position: 'left',
                                // 使用函数格式化数值（核心改动）
                                formatter: (params) => {
                                    // 确保数值为 Number 类型
                                    const value = parseFloat(params.value);
                                    return value.toFixed(2); // 保留两位小数
                                },
                                color: '#ff0000',
                                fontSize: 14,
                                //backgroundColor: '#f8f8f8',
                                backgroundColor: 'transparent',
                                distance: 15,
                                rotate: 0,
                            }
                        },
                        */
                        markPoint: {
                            // ...现有配置...
                            data: [
                                // ...现有标记...
                                {
                                    type: 'max',
                                    name: '最高点',
                                    symbol: 'pin',
                                    symbolSize: 30,
                                    label: {
                                        formatter: '最高:{c}',
                                        position: 'top'
                                    }
                                },
                                {
                                    type: 'min',
                                    name: '最低点',
                                    symbol: 'pin',
                                    symbolSize: 30,
                                    label: {
                                        formatter: '最低:{c}',
                                        position: 'bottom'
                                    }
                                }
                            ]
                        },
                        type: 'line',
                        showSymbol: range === 'all' ? false : true, // 动态控制，默认隐藏，悬停时显示
                        smooth: true,
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(24,144,255,0.6)' },
                                { offset: 1, color: 'rgba(24,144,255,0.01)' }
                            ])
                        },
                        itemStyle: {
                            color: '#1890ff'
                        },
                    },
                    {
                        name: '30日均线',
                        type: 'line',
                        data: calculateMovingAverage(filteredData, 30),
                        smooth: true,
                        symbol: 'none',
                        lineStyle: {
                            width: 2,
                            type: 'dashed',
                            color: '#ff6b6b'
                        },
                        tooltip: {
                            valueFormatter: value => value.toFixed(4)
                        }
                    },
                    {
                        name: '趋势线',
                        type: 'line',
                        data: calculateRegressionLine(filteredData),
                        symbol: 'none',
                        lineStyle: {
                            width: 2,
                            color: '#52c41a'
                        }
                    },
                    {
                        name: '初始净值',
                        type: 'line',
                        markLine: {
                            data: [{
                                yAxis: filteredData[0]?.net_value || 1.0,
                                label: { show: true, formatter: '初始值: {c}' }
                            }],
                            symbol: 'none',
                            lineStyle: {
                                color: '#f39c12',
                                type: 'dotted'
                            }
                        },
                        silent: true
                    }
                ],
                dataZoom: [
                    {
                    type: 'inside', // 内置型缩放
                    xAxisIndex: 0,
                    start: 0,
                    end: 100,
                    zoomLock: true // 锁定纵轴缩放
                    },
                    {
                    type: 'slider', // 滑动条缩放
                    show: true,
                    xAxisIndex: [0],
                    bottom: 20, // 为图例腾出空间
                    height: 20
                    }
                ],
                tooltip: {
                    trigger: 'axis',

                    backgroundColor: 'rgba(255,255,255,0.9)',
                    borderColor: '#eee',
                    borderWidth: 1,
                    textStyle: {
                        fontSize: 14
                    },
                    extraCssText: 'box-shadow: 0 0 10px rgba(0,0,0,0.1);',
                    axisPointer: {
                        type: 'cross',
                        lineStyle: {
                            type: 'dashed'
                        }
                    },

                    formatter: function (params) {
                        // 获取原始时间戳（或日期字符串）
                        const rawDate = params[0].axisValue;
                        // 创建日期对象（兼容时间戳和字符串）
                        const dateObj = new Date(typeof rawDate === 'number' ? rawDate : rawDate);
                        // 使用echarts内置格式化工具
                        const formattedDate = echarts.time.format(
                            dateObj,
                            '{yyyy}-{MM}-{dd}',
                            false
                        );
                        let tooltip = `<div style="font-weight:bold;margin-bottom:8px;">${formattedDate}</div>`;
                        params.forEach(param => {
                            const color = param.color;
                            const seriesName = param.seriesName;
                            const value = param.data[1].toFixed(4);
                            //tooltip += `${marker} ${seriesName}: ${value}<br/>`;
                            tooltip += `<div style="display:flex;align-items:center;">
                                    <span class="icon-rect" style="background:${color};"></span>
                                    ${seriesName}：<span style="font-weight:bold;color:${color}">${value}</span>
                                </div>`;

                        });
                        return tooltip;
                    }
                }
            };
            chart.setOption(option, true);
        }

        // 移动平均线计算函数
        function calculateMovingAverage(data, period) {
            const result = [];
            let sum = 0;

            for (let i = 0; i < data.length; i++) {
                sum += data[i].net_value;
                if (i >= period) sum -= data[i - period].net_value;

                if (i >= period - 1) {
                    result.push([
                        new Date(data[i].date).getTime(),
                        sum / Math.min(period, i + 1)
                    ]);
                }
            }
            return result;
        }

        // 线性回归计算
        function calculateRegressionLine(data) {
            if (data.length < 2) return [];

            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
            const n = data.length;

            for (let i = 0; i < n; i++) {
                const x = i;
                const y = data[i].net_value;
                sumX += x;
                sumY += y;
                sumXY += x * y;
                sumX2 += x * x;
            }

            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            return [
                [new Date(data[0].date).getTime(), intercept],
                [new Date(data[n-1].date).getTime(), intercept + slope * (n-1)]
            ];
        }

        // 按钮事件
        document.querySelectorAll('#netvalueChartSwitch [data-range]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#netvalueChartSwitch [data-range]').forEach(b =>
                    b.classList.remove('active'));
                this.classList.add('active');
                updateChart(this.dataset.range);
            });
        });

        // 初始加载
        updateChart(currentRange);
        window.addEventListener('resize', () => chart.resize());
    });

    // 资产曲线
    document.addEventListener('DOMContentLoaded', function() {
        const chart = echarts.init(document.getElementById('valueChart'));
        const allData = {{ fund_data|safe }};
        let currentRange = 'currentYear';

        // 时间范围计算
        function getDateRange(range) {
            const now = new Date();
            const ranges = {
                all: new Date(0),
                year: new Date(now.getFullYear() - 1, now.getMonth(), now.getDate()),
                month: (() => {
                    const currentYear = now.getFullYear();
                    const currentMonth = now.getMonth();
                    const currentDay = now.getDate();

                    // 计算目标月份和年份
                    let targetYear, targetMonth;
                    if (currentMonth === 0) {
                        targetYear = currentYear - 1;
                        targetMonth = 11; // 12月
                    } else {
                        targetYear = currentYear;
                        targetMonth = currentMonth - 1; // 上月
                    }

                    // 获取目标月份的最后一天
                    const lastDayOfTargetMonth = new Date(targetYear, targetMonth + 1, 0).getDate();

                    // 判断是否需要调整日期
                    if (currentDay > lastDayOfTargetMonth) {
                        // 超出则设为当前月份的第一天
                        return new Date(currentYear, currentMonth, 1);
                    } else {
                        // 未超出则保持目标月份的对应日期
                        return new Date(targetYear, targetMonth, currentDay);
                    }
                })(),
                currentYear: new Date(now.getFullYear(), 0, 1)
            };
            return ranges[range] || ranges.all;
        }

        // 更新图表
        function updateChart(range) {
            const startDate = getDateRange(range);
            const filteredData = allData.filter(d => new Date(d.date) >= startDate);
            const option = {
                grid: {
                    left: '2%',    // 调整为更小的值
                    right: '2%',
                    top: '2%',
                    bottom: '0%',
                    containLabel: true
                },
                xAxis: {
                    type: 'time',
                    axisLabel: {
                        rotate: 45,
                        margin: 15,
                        interval: (index, timestamp) => {
                            const axis = chart.getModel().getComponent('xAxis', 0).axis;
                            const [min, max] = axis.scale.getExtent();
                            const totalDays = (max - min) / (1000 * 3600 * 24);

                            if (totalDays <= 7) return index % 1 === 0;
                            if (totalDays <= 30) return index % 2 === 0;
                            return index % Math.ceil(totalDays/30) === 0;
                        },
                        formatter: function (value) {
                            const date = new Date(value);
                            // 处理闰年2月29日
                            if (date.getMonth() === 1 && date.getDate() === 29) {
                                return '02-29';
                            }
                            const rangeType = range;

                            if (rangeType === 'currentYear' || rangeType === 'month') {
                                const axis = chart.getModel().getComponent('xAxis', 0).axis;
                                const [min, max] = axis.scale.getExtent();
                                const dayDiff = (max - min) / (1000 * 3600 * 24);

                                // 精确判断逻辑
                                if (dayDiff <= 60) { // 调整为60天阈值
                                    const month = (date.getMonth()+1).toString().padStart(2, '0');
                                    const day = date.getDate().toString().padStart(2, '0');
                                    return `${month}-${day}`;
                                }
                                //return `${date.getFullYear().slice(-2)}-${(date.getMonth()+1).toString().padStart(2, '0')}`;
                                return `${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                            }

                            if (rangeType === 'all') {
                                return `${date.getFullYear()}`;
                            }
                            return `${date.getFullYear().toString().slice(-2)}-${(date.getMonth()+1).toString().padStart(2, '0')}`;
                        }
                    },
                    axisTick: {
                        alignWithLabel: true
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#ccc'
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    min: 'dataMin',
                    axisLabel: {
                        formatter: value => value.toFixed(0)
                    },
                    splitLine: {
                        show: true,
                        lineStyle: {
                            type: 'dashed',
                            color: '#eee'
                        }
                    },
                    axisLine: {
                        show: false,
                        lineStyle: {
                            color: '#ccc'
                        }
                    }
                },
                series: [
                    // 原有资产数据系列
                    {
                        name: '资产',
                        data: filteredData.map(d => [
                            new Date(d.date).getTime(), // 转换为时间戳
                            d.value
                        ]),
                        yAxisIndex: 0, // 指定使用左侧轴
                        markPoint: {
                             // 根据条件生成数据数组（核心逻辑）
                            data: (range === 'all') ? [
                                { type: 'max', symbol: 'circle', symbolSize: 5, itemStyle: { color: 'orange' }},
                                { type: 'min', symbol: 'circle', symbolSize: 5, itemStyle: { color: 'orange' } }
                            ] : [],
                            //label: { show: false } // 显示标签及数值
                            label: {
                                show: false,
                                position: 'left',
                                // 使用函数格式化数值（核心改动）
                                formatter: (params) => {
                                    // 确保数值为 Number 类型
                                    const value = parseFloat(params.value);
                                    return value.toFixed(2); // 保留两位小数
                                },
                                color: '#ff0000',
                                fontSize: 14,
                                //backgroundColor: '#f8f8f8',
                                backgroundColor: 'transparent',
                                distance: 15,
                                rotate: 0,
                            }
                        },
                        type: 'line',
                        showSymbol: range === 'all' ? false : true, // 动态控制，默认隐藏，悬停时显示
                        smooth: true,
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(24,144,255,0.6)' },
                                { offset: 1, color: 'rgba(24,144,255,0.01)' }
                            ])
                        },
                        itemStyle: {
                            color: '#1890ff'
                        }
                    },
                    // 本金数据系列
                    {
                        name: '本金',
                        data: filteredData.map(d => [
                            new Date(d.date).getTime(), // 转换为时间戳
                            d.principal
                        ]),
                        yAxisIndex: 0, // 指定使用左侧轴
                        markPoint: {
                             // 根据条件生成数据数组（核心逻辑）
                            data: (range === 'all') ? [
                                { type: 'max', symbol: 'circle', symbolSize: 5, itemStyle: { color: 'orange' }},
                                { type: 'min', symbol: 'circle', symbolSize: 5, itemStyle: { color: 'orange' } }
                            ] : [],
                            //label: { show: false } // 显示标签及数值
                            label: {
                                show: false,
                                position: 'left',
                                // 使用函数格式化数值（核心改动）
                                formatter: (params) => {
                                    // 确保数值为 Number 类型
                                    const value = parseFloat(params.value);
                                    return value.toFixed(2); // 保留两位小数
                                },
                                color: '#ff0000',
                                fontSize: 14,
                                //backgroundColor: '#f8f8f8',
                                backgroundColor: 'transparent',
                                distance: 15,
                                rotate: 0,
                            }
                        },
                        type: 'line',
                        showSymbol: range === 'all' ? false : true, // 动态控制，默认隐藏，悬停时显示
                        smooth: true,
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(24,144,255,0.6)' },
                                { offset: 1, color: 'rgba(24,144,255,0.01)' }
                            ])
                        },
                        itemStyle: {
                            color: '#ee9945'
                        }
                    }
                ],
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        const rawDate = params[0].axisValue;
                        const dateObj = new Date(typeof rawDate === 'number' ? rawDate : rawDate);
                        const formattedDate = echarts.time.format(dateObj, '{yyyy}-{MM}-{dd}', false);

                        let tooltip = `<div style="font-weight:bold;margin-bottom:8px;">${formattedDate}</div>`;
                        params.forEach(param => {
                            const color = param.color;
                            const seriesName = param.seriesName;
                            const value = param.data[1].toLocaleString('zh-CN', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            });
                            tooltip += `<div style="display:flex;align-items:center;">
                                    <span class="icon-rect" style="background:${color};"></span>
                                    ${seriesName}：<span style="font-weight:bold;color:${color}">${value}万</span>
                                </div>`;
                        });
                        return tooltip;
                    }
                },
                legend: {
                    data: ['资产', '本金'],
                    top: 15
                }
            };
            chart.setOption(option, true);
        }

        // 按钮事件
        document.querySelectorAll('#valueChartSwitch [data-range]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#valueChartSwitch [data-range]').forEach(b =>
                    b.classList.remove('active'));
                this.classList.add('active');
                updateChart(this.dataset.range);
            });
        });

        // 初始加载
        updateChart(currentRange);
        window.addEventListener('resize', () => chart.resize());
    });

    // 收益曲线
    document.addEventListener('DOMContentLoaded', function() {
        const chart = echarts.init(document.getElementById('profitChart'));
        const allData = {{ fund_data|safe }};
        let currentRange = 'currentYear';

        // 时间范围计算
        function getDateRange(range) {
            const now = new Date();
            const ranges = {
                all: new Date(0),
                year: new Date(now.getFullYear() - 1, now.getMonth(), now.getDate()),
                month: (() => {
                    const currentYear = now.getFullYear();
                    const currentMonth = now.getMonth();
                    const currentDay = now.getDate();

                    // 计算目标月份和年份
                    let targetYear, targetMonth;
                    if (currentMonth === 0) {
                        targetYear = currentYear - 1;
                        targetMonth = 11; // 12月
                    } else {
                        targetYear = currentYear;
                        targetMonth = currentMonth - 1; // 上月
                    }

                    // 获取目标月份的最后一天
                    const lastDayOfTargetMonth = new Date(targetYear, targetMonth + 1, 0).getDate();

                    // 判断是否需要调整日期
                    if (currentDay > lastDayOfTargetMonth) {
                        // 超出则设为当前月份的第一天
                        return new Date(currentYear, currentMonth, 1);
                    } else {
                        // 未超出则保持目标月份的对应日期
                        return new Date(targetYear, targetMonth, currentDay);
                    }
                })(),
                currentYear: new Date(now.getFullYear(), 0, 1)
            };
            return ranges[range] || ranges.all;
        }

        // 更新图表
        function updateChart(range) {
            const startDate = getDateRange(range);
            const filteredData = allData.filter(d => new Date(d.date) >= startDate);
            const option = {
                grid: {
                    left: '2%',    // 调整为更小的值
                    right: '2%',
                    top: '2%',
                    bottom: '0%',
                    containLabel: true
                },
                xAxis: {
                    type: 'time',
                    axisLabel: {
                        rotate: 45,
                        margin: 15,
                        interval: (index, timestamp) => {
                            const axis = chart.getModel().getComponent('xAxis', 0).axis;
                            const [min, max] = axis.scale.getExtent();
                            const totalDays = (max - min) / (1000 * 3600 * 24);

                            if (totalDays <= 7) return index % 1 === 0;
                            if (totalDays <= 30) return index % 2 === 0;
                            return index % Math.ceil(totalDays/30) === 0;
                        },
                        formatter: function (value) {
                            const date = new Date(value);
                            // 处理闰年2月29日
                            if (date.getMonth() === 1 && date.getDate() === 29) {
                                return '02-29';
                            }
                            const rangeType = range;

                            if (rangeType === 'currentYear' || rangeType === 'month') {
                                const axis = chart.getModel().getComponent('xAxis', 0).axis;
                                const [min, max] = axis.scale.getExtent();
                                const dayDiff = (max - min) / (1000 * 3600 * 24);

                                // 精确判断逻辑
                                if (dayDiff <= 60) { // 调整为60天阈值
                                    const month = (date.getMonth()+1).toString().padStart(2, '0');
                                    const day = date.getDate().toString().padStart(2, '0');
                                    return `${month}-${day}`;
                                }
                                //return `${date.getFullYear().slice(-2)}-${(date.getMonth()+1).toString().padStart(2, '0')}`;
                                return `${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                            }

                            if (rangeType === 'all') {
                                return `${date.getFullYear()}`;
                            }
                            return `${date.getFullYear().toString().slice(-2)}-${(date.getMonth()+1).toString().padStart(2, '0')}`;
                        }
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#ccc'
                        }
                    },
                    axisTick: {
                        alignWithLabel: true
                    }
                },
                yAxis: {
                    type: 'value',
                    min: 'dataMin',
                    axisLabel: {
                        formatter: value => value.toFixed(0)
                    },
                    splitLine: {
                        show: true,
                        lineStyle: {
                            type: 'dashed',
                            color: '#eee'
                        }
                    },
                    axisLine: {
                        show: false,
                        lineStyle: {
                            color: '#ccc'
                        }
                    }
                },
                series: [
                    // 原有资产数据系列
                    {
                        name: '收益',
                        data: filteredData.map(d => [
                            new Date(d.date).getTime(), // 转换为时间戳
                            d.profit
                        ]),
                        yAxisIndex: 0, // 指定使用左侧轴
                        markPoint: {
                             // 根据条件生成数据数组（核心逻辑）
                            data: (range === 'all') ? [
                                { type: 'max', symbol: 'circle', symbolSize: 5, itemStyle: { color: 'orange' }},
                                { type: 'min', symbol: 'circle', symbolSize: 5, itemStyle: { color: 'orange' } }
                            ] : [],
                            //label: { show: false } // 显示标签及数值
                            label: {
                                show: false,
                                position: 'left',
                                // 使用函数格式化数值（核心改动）
                                formatter: (params) => {
                                    // 确保数值为 Number 类型
                                    const value = parseFloat(params.value);
                                    return value.toFixed(2); // 保留两位小数
                                },
                                color: '#ff0000',
                                fontSize: 14,
                                //backgroundColor: '#f8f8f8',
                                backgroundColor: 'transparent',
                                distance: 15,
                                rotate: 0,
                            }
                        },
                        type: 'line',
                        showSymbol: range === 'all' ? false : true, // 动态控制，默认隐藏，悬停时显示
                        smooth: true,
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(24,144,255,0.6)' },
                                { offset: 1, color: 'rgba(24,144,255,0.01)' }
                            ])
                        },
                        itemStyle: {
                            color: '#1890ff'
                        }
                    }
                ],
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        const color = params[0].color;
                        const seriesName = params[0].seriesName;
                        const value = params[0].data[1].toLocaleString('zh-CN', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                        const rawDate = params[0].axisValue; // 获取原始时间戳（或日期字符串）
                        const dateObj = new Date(typeof rawDate === 'number' ? rawDate : rawDate); // 创建日期对象（兼容时间戳和字符串）
                        const formattedDate = echarts.time.format(
                            dateObj,
                            '{yyyy}-{MM}-{dd}',
                            false
                        );
                        return `<div style="font-weight:bold;margin-bottom:8px;">${formattedDate}</div>
                                <div style="display:flex;align-items:center;">
                                    <span class="icon-rect" style="background:${color};"></span>
                                    ${seriesName}：<span style="font-weight:bold;color:${color}">${value}万</span>
                                </div>`;
                    }

                },
            };
            chart.setOption(option, true);
        }

        // 按钮事件
        document.querySelectorAll('#profitChartSwitch [data-range]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#profitChartSwitch [data-range]').forEach(b =>
                    b.classList.remove('active'));
                this.classList.add('active');
                updateChart(this.dataset.range);
            });
        });

        // 初始加载
        updateChart(currentRange);
        window.addEventListener('resize', () => chart.resize());
    });

    // 资产日历
    document.addEventListener('DOMContentLoaded', function() {
        const assetChanges = {{ assetChanges|safe }};

        // 初始化当前日期
        const today = new Date(); // 当前日期
        let currentYear = today.getFullYear(); // 当前年份
        let currentMonth = today.getMonth(); // 当前月份（0-11）
        let currentView = 'month'; // 当前视图（月视图）

        /* 格式化资产值为带万单位或千位分隔的字符串 */
        function formatAmount(amount) {
            if (amount === 0) return '0'; // 零值直接返回
            const isNegative = amount < 0; // 是否为负数
            const absAmount = Math.abs(amount); // 绝对值
            let formatted = "";
            if (absAmount >= 10000) { // 资产大于等于 1 万时，以万为单位显示
                formatted = `${(absAmount / 10000).toFixed(2)}万`;
            } else { // 否则，显示千位分隔的整数
                formatted = absAmount.toFixed(0).toLocaleString();
            }
            return `${isNegative ? '-' : '+'}${formatted}`; // 返回带正负号的格式化字符串
        }

        // 获取指定年份和月份的总资产变化
        function getMonthlyTotal(year, month) {
            const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`; // 月份前缀
            return Object.entries(assetChanges) // 遍历资产数据
                .filter(([date]) => date.startsWith(monthKey)) // 筛选当前月的数据
                .reduce((sum, [_, amount]) => sum + amount, 0); // 累加总和
        }

        // 渲染日历内容
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid'); // 获取日期网格
            grid.innerHTML = ''; // 清空网格内容

            if (currentView === 'month') { // 如果是月视图
                renderMonthView(); // 渲染月视图
            } else { // 否则，渲染年视图
                renderYearView();
            }

            updateNavigation(); // 更新导航按钮状态
            updateSummary(); // 更新摘要信息
        }

        // 渲染月视图
        function renderMonthView() {
            const grid = document.getElementById('calendarGrid'); // 获取日期网格
            grid.className = 'date-grid'; // 设置网格样式
            document.getElementById('weekHeader').style.display = 'grid'; // 显示星期头

            const dates = getDaysOfMonth(currentYear, currentMonth); // 获取本月的所有天数

            dates.forEach(date => {
                const cell = document.createElement('div'); // 创建日期单元格
                cell.className = 'day-cell'; // 设置默认样式

                if (date.getMonth() === currentMonth) { // 如果日期属于当前月
                    const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`; // 日期字符串
                    const dailyChange = assetChanges[dateString] || 0; // 获取资产变化值

                    // 资产变化值的样式处理
                    if (dailyChange > 0) {
                        cell.classList.add('positive'); // 添加正资产样式
                    } else if (dailyChange < 0) {
                        cell.classList.add('negative'); // 添加负资产样式
                    }

                    cell.textContent = date.getDate(); // 显示日期

                    const valueSpan = document.createElement('span'); // 创建资产值容器
                    valueSpan.className = 'asset-value'; // 设置样式
                    valueSpan.textContent = formatAmount(dailyChange); // 显示格式化后的资产值
                    cell.appendChild(valueSpan); // 将资产值添加到单元格

                    // 当前日期的样式处理
                    if (date.toDateString() === today.toDateString()) {
                        cell.classList.add('current-day'); // 添加当前日期样式
                    }
                } else { // 如果是前一个月或下一个月的日期
                    cell.classList.add('bg-light', 'text-muted'); // 添加灰度样式
                    cell.textContent = ''; // 非当前月日期显示为空
                }

                grid.appendChild(cell); // 将单元格添加到网格
            });

            document.getElementById('timeDisplay').textContent = `${currentYear}年 ${currentMonth + 1}月`; // 更新时间显示
        }

        // 渲染年视图
        function renderYearView() {
            const grid = document.getElementById('calendarGrid'); // 获取日期网格
            grid.className = 'date-grid month-grid'; // 设置网格样式
            document.getElementById('weekHeader').style.display = 'none'; // 隐藏星期头

            const today = new Date(); // 获取当前日期
            const currentActualYear = today.getFullYear();
            const currentActualMonth = today.getMonth();

            for(let month = 0; month < 12; month++) { // 循环 12 个月
                const cell = document.createElement('div'); // 创建月份单元格
                cell.className = 'month-cell'; // 设置默认样式
                cell.dataset.year = currentYear; // 设置年份数据
                cell.dataset.month = month; // 设置月份数据

                const monthlyTotal = getMonthlyTotal(currentYear, month); // 获取该月的总资产变化
                // 总资产变化的样式处理
                if(monthlyTotal > 0) {
                    cell.classList.add('positive'); // 添加正资产样式
                } else if(monthlyTotal < 0) {
                    cell.classList.add('negative'); // 添加负资产样式
                }

                cell.textContent = `${month + 1}月`; // 显示月份

                const valueSpan = document.createElement('span'); // 创建资产值容器
                valueSpan.className = 'asset-value'; // 设置样式
                valueSpan.textContent = formatAmount(monthlyTotal); // 显示格式化后的资产值
                cell.appendChild(valueSpan); // 将资产值添加到单元格

                // 判断是否为当前年份的未来月份
                if (currentYear === currentActualYear && month > currentActualMonth) {
                    // 禁用点击事件
                    cell.style.cursor = 'not-allowed';
                    cell.style.opacity = 0.5;
                    cell.style.userSelect = 'none';
                    // 移除悬停效果
                    cell.classList.remove('hover-effect');
                } else {
                    // 允许点击
                    cell.style.cursor = 'pointer';
                    cell.style.opacity = 1;
                    cell.style.userSelect = 'text';
                    // 添加点击事件监听
                    cell.addEventListener('click', handleMonthClick);
                }

                grid.appendChild(cell); // 将单元格添加到网格
            }

            document.getElementById('timeDisplay').textContent = `${currentYear}年`; // 更新时间显示
        }

        // 处理月份点击事件
        function handleMonthClick(event) {
            const cell = event.currentTarget; // 获取被点击的单元格元素
            currentYear = parseInt(cell.dataset.year); // 更新当前年份
            currentMonth = parseInt(cell.dataset.month); // 更新当前月份
            currentView = 'month'; // 切换到月视图

            // 更新视图切换按钮的状态
            document.querySelectorAll('#viewSwitch button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === 'month'); // 设置按钮的活动状态
            });

            renderCalendar(); // 重新渲染日历
        }

        // 更新摘要信息
        function updateSummary() {
            let total = 0; // 总资产变化

            if (currentView === 'month') { // 月视图
                total = getMonthlyTotal(currentYear, currentMonth); // 获取当前月总和
            } else { // 年视图
                for (let m = 0; m < 12; m++) { // 遍历 12 个月
                    total += getMonthlyTotal(currentYear, m); // 累加每月总和
                }
            }

            // 更新摘要信息
            document.getElementById('periodSummary').textContent = `${currentView === 'month' ? '本月' : '本年'}资产变化汇总：${formatAmount(total)}`;
            // 取消加粗
            document.getElementById('periodSummary').style.fontWeight = "normal";
        }

        // 更新导航按钮的状态
        function updateNavigation() {
            const prevBtn = document.getElementById('prevBtn'); // 上一周期按钮
            const nextBtn = document.getElementById('nextBtn'); // 下一周期按钮

            if(currentView === 'month') { // 月视图
                //prevBtn.textContent = '上一月'; // 设置按钮文本
                //nextBtn.textContent = '下一月';
                prevBtn.title = '上一月'; // 设置按钮文本
                nextBtn.title = '下一月';
                const isCurrentMonth = currentYear === today.getFullYear() &&
                                    currentMonth === today.getMonth(); // 是否为当前月
                nextBtn.disabled = isCurrentMonth; // 禁用下一月按钮（如果当前月）
            } else { // 年视图
                //prevBtn.textContent = '上一年'; // 设置按钮文本
                //nextBtn.textContent = '下一年';
                prevBtn.title = '上一年'; // 设置按钮文本
                nextBtn.title = '下一年';
                nextBtn.disabled = currentYear >= today.getFullYear(); // 禁用下一年按钮（如果当前年）
            }
        }

        // 获取指定年份和月份的所有日期
        function getDaysOfMonth(year, month) {
            const firstDay = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dates = [];

            // 计算需要补全的前置工作日
            let prependDays = 0;
            if (firstDay.getDay() !== 0 && firstDay.getDay() !== 6) {
                prependDays = firstDay.getDay() - 1;
            }

            // 生成前置日期（上月）
            for (let i = prependDays; i > 0; i--) {
                dates.push(new Date(year, month, 1 - i));
            }

            // 生成当前月工作日
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                if (date.getDay() !== 0 && date.getDay() !== 6) {
                    dates.push(date);
                }
            }

            // 补全后续日期（下月）
            const total = dates.length;
            const remainder = total % 5;
            const appendDays = remainder === 0 ? 0 : 5 - remainder;

            let nextMonthDay = 1;
            let appended = 0;
            while (appended < appendDays) {
                const date = new Date(year, month + 1, nextMonthDay);
                if (date.getDay() !== 0 && date.getDay() !== 6) {
                    dates.push(date);
                    appended++;
                }
                nextMonthDay++;
            }

            return dates;
        }

        // 上一周期导航
        function prevPeriod() {
            if (currentView === 'month') { // 月视图
                currentMonth--; // 上一月
                if (currentMonth < 0) {
                    currentMonth = 11; // 跳转到前一年
                    currentYear--;
                }
            } else { // 年视图
                currentYear--; // 上一年
            }
            renderCalendar(); // 重新渲染日历
        }

        // 下一周期导航
        function nextPeriod() {
            if (currentView === 'month') { // 月视图
                const nextDate = new Date(currentYear, currentMonth + 1); // 下一月
                if (nextDate <= new Date(today.getFullYear(), today.getMonth() + 1)) { // 如果未超过当前日期
                    currentMonth++; // 下一月
                    if (currentMonth > 11) {
                        currentMonth = 0; // 跳转到下一年
                        currentYear++;
                    }
                }
            } else { // 年视图
                currentYear++; // 下一年
            }
            renderCalendar(); // 重新渲染日历
        }

        // 事件监听
        document.getElementById('prevBtn').addEventListener('click', prevPeriod); // 上一周期按钮点击事件
        document.getElementById('nextBtn').addEventListener('click', nextPeriod); // 下一周期按钮点击事件

        // 视图切换按钮的点击事件
        document.querySelectorAll('#viewSwitch button').forEach(btn => {
            btn.addEventListener('click', function() {
                const newView = this.dataset.type; // 获取按钮的数据视图类型
                if (newView !== currentView) { // 如果视图切换
                    currentView = newView; // 更新当前视图
                    document.querySelectorAll('#viewSwitch button').forEach(b =>
                        b.classList.remove('active')); // 移除所有按钮的活动状态
                    this.classList.add('active'); // 设置当前按钮为活动状态

                    if (currentView === 'year') { // 如果切换到年视图
                        // 保留当前年份
                    } else { // 切换到月视图
                        if (this.dataset.type === 'month') { // 如果是月视图按钮
                            currentYear = today.getFullYear(); // 重置到当前年份
                            currentMonth = today.getMonth(); // 重置到当前月份
                        }
                    }
                    renderCalendar(); // 重新渲染日历
                }
            });
        });

        // 初始渲染
        renderCalendar();


    })

    // 资产、收益、出入金列表
    document.addEventListener('DOMContentLoaded', function() {
        // 获取DOM元素
        const titleElement = document.getElementById('dataListTitle');
        const fundTable = document.getElementById('fundTable');
        const profitTable = document.getElementById('profitTable');
        const inoutTable = document.getElementById('inoutTable');

        // 设置激活按钮样式
        function setActiveButton(activeRange) {
            const buttons = document.querySelectorAll('#dataListSwitch button');
            buttons.forEach(button => {
                button.classList.remove('active');
                if (button.dataset.range === activeRange) {
                    button.classList.add('active');
                }
            });

            // 更新卡片标题
            titleElement.innerHTML = `${
                activeRange === 'fund' ? '资产列表' :
                activeRange === 'profit' ? '收益列表' :
                '出入金列表'
            }`;
        }

        // 显示指定表格
        function showTable(range) {
            fundTable.style.display = range === 'fund' ? 'block' : 'none';
            profitTable.style.display = range === 'profit' ? 'block' : 'none';
            inoutTable.style.display = range === 'inout' ? 'block' : 'none';
            setActiveButton(range);
        }

        // 初始状态
        showTable('fund');

        // 添加切换按钮事件
        document.querySelectorAll('#dataListSwitch button').forEach(button => {
            button.addEventListener('click', function() {
                showTable(this.dataset.range);
            });
        });

    });

    // 年度收益柱图及列表
    document.addEventListener('DOMContentLoaded', function() {
        const yearlyData = {{ yearly_profit_data|safe }};

        // 按年份升序排列
        yearlyData.sort((a, b) => a.year - b.year);

        // 准备图表数据
        const years = yearlyData.map(item => item.year);
        const amounts = yearlyData.map(item => item.amount);
        const colors = yearlyData.map(item =>
            item.amount < 0 ? '#2c9f5c' : '#c84f4f'
        );


        // 初始化图表
        const chart = echarts.init(document.getElementById('yearly-Profit-chart'));

        // 更新图表
        function updateChart() {
            const option = {
                title: {
                    text: '年度收益统计',
                    left: 'center',
                    textStyle: {
                        fontSize: 18,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    borderColor: '#ddd',
                    borderWidth: 1,
                    padding: [10, 15],
                    textStyle: {
                        color: '#333'
                    },
                    formatter: function(params) {
                        const name = params[0].name;
                        const color = params[0].color;
                        const value = params[0].value;
                        const type = value >= 0 ? '盈利' : '亏损';
                        const absValue = Math.abs(value).toLocaleString('zh-CN', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });

                        return `<div style="font-weight:bold;margin-bottom:8px;">${name}年</div>
                                <div style="display:flex;align-items:center;">
                                    <span class="icon-rect" style="background:${color};"></span>
                                    ${type}：<span style="font-weight:bold;color:${color}">${absValue}万</span>
                                </div>`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '3%',
                    bottom: '3%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    //name: '年份',
                    //data: years.map(year => year + '年'),
                    data: years,
                    //boundaryGap: true,
                    axisLabel: {
                        interval: 0,
                        rotate: 45,
                        fontSize: 12
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#ccc'
                        }
                    },
                    axisTick: {
                        alignWithLabel: false
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '金额（万元）',
                    nameTextStyle: {
                        padding: [0, 0, 0, 40]
                    },
                    axisLabel: {
                        formatter: function(value) {
                            return value.toLocaleString(); // 千位分隔
                        },
                        fontSize: 12
                    },
                    splitLine: {
                        show: true,
                        lineStyle: {
                            type: 'dashed',
                            color: '#eee'
                        }
                    },
                    axisLine: {
                        show: false,
                        lineStyle: {
                            color: '#ccc'
                        }
                    }
                },
                series: [{
                    name: '年度出入金',
                    type: 'bar',
                    data: amounts,
                    itemStyle: {
                        color: function(params) {
                            return colors[params.dataIndex];
                        },
                        borderRadius: [2, 2, 2, 2]
                    },
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowColor: function(params) {
                                return params.color + '66';
                            },
                            borderRadius: [2, 2, 2, 2]
                        }
                    },
                    label: {
                        show: true,
                        position: 'top',
                        formatter: function(params) {
                            return params.value.toFixed(0);
                        },
                        fontSize: 12,
                        fontWeight: 'bold',
                        color: '#333'
                    }
                }],
                dataZoom: [{
                    type: 'inside',
                    start: 0,
                    end: 100,
                    zoomLock: true
                }]
            };

            chart.setOption(option, true);
        }

        // 视图切换功能
        function setupViewToggle() {
            // const toggleButtons = document.querySelectorAll('.btn-toggle');
            const toggleButtons = document.querySelectorAll('#view-toggle-Profit button');
            const chartContainer = document.getElementById('chart-container-Profit');
            const tableContainer = document.getElementById('table-container-Profit');

            toggleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 更新按钮状态
                    toggleButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');

                    // 切换视图
                    const view = this.dataset.view;
                    if (view === 'chart') {
                        chartContainer.style.display = 'block';
                        tableContainer.style.display = 'none';
                        chart.resize();
                    } else {
                        chartContainer.style.display = 'none';
                        tableContainer.style.display = 'block';
                    }
                });
            });
        }

        // 初始加载
        updateChart();
        setupViewToggle();

        // 响应式调整
        window.addEventListener('resize', function() {
            chart.resize();
        });
    });

    // 年度出入金柱图及列表
    document.addEventListener('DOMContentLoaded', function() {
        const yearlyData = {{ yearly_in_out_data|safe }};

        // 按年份升序排列
        yearlyData.sort((a, b) => a.year - b.year);

        // 准备图表数据
        const years = yearlyData.map(item => item.year);
        const amounts = yearlyData.map(item => item.amount);
        const colors = yearlyData.map(item =>
            item.amount < 0 ? '#2c9f5c' : '#c84f4f'
        );

        // 初始化图表
        const chart = echarts.init(document.getElementById('yearly-InOut-chart'));

        // 更新图表
        function updateChart() {
            const option = {
                title: {
                    text: '年度出入金统计',
                    left: 'center',
                    textStyle: {
                        fontSize: 18,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    borderColor: '#ddd',
                    borderWidth: 1,
                    padding: [10, 15],
                    textStyle: {
                        color: '#333'
                    },
                    formatter: function(params) {
                        const name = params[0].name
                        const color = params[0].color;
                        const value = params[0].value;
                        const type = value >= 0 ? '入金' : '出金';
                        const absValue = Math.abs(value).toLocaleString('zh-CN', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });

                        return `<div style="font-weight:bold;margin-bottom:8px;">${name}年</div>
                                <div style="display:flex;align-items:center;">
                                    <span class="icon-rect" style="background:${color};"></span>
                                    ${type}：<span style="font-weight:bold;color:${color}">${absValue}万</span>
                                </div>`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '3%',
                    bottom: '3%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    //name: '年份',
                    //data: years.map(year => year + '年'),
                    data: years,
                    //boundaryGap: true,
                    axisLabel: {
                        interval: 0,
                        rotate: 45,
                        fontSize: 12
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#ccc'
                        }
                    },
                    axisTick: {
                        alignWithLabel: false
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '金额（万元）',
                    nameTextStyle: {
                        padding: [0, 0, 0, 40]
                    },
                    axisLabel: {
                        formatter: function(value) {
                            return value.toLocaleString(); // 千位分隔
                        },
                        fontSize: 12
                    },
                    splitLine: {
                        show: true,
                        lineStyle: {
                            type: 'dashed',
                            color: '#eee'
                        }
                    },
                    axisLine: {
                        show: false,
                        lineStyle: {
                            color: '#ccc'
                        }
                    }
                },
                series: [{
                    name: '年度出入金',
                    type: 'bar',
                    data: amounts,
                    itemStyle: {
                        color: function(params) {
                            return colors[params.dataIndex];
                        },
                        borderRadius: [2, 2, 2, 2]
                    },
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowColor: function(params) {
                                return params.color + '66';
                            },
                            borderRadius: [2, 2, 2, 2]
                        }
                    },
                    label: {
                        show: true,
                        position: 'top',
                        formatter: function(params) {
                            return params.value.toFixed(0);
                        },
                        fontSize: 12,
                        fontWeight: 'bold',
                        color: '#333'
                    }
                }],
                dataZoom: [{
                    type: 'inside',
                    start: 0,
                    end: 100,
                    zoomLock: true
                }]
            };

            chart.setOption(option, true);
        }

        // 视图切换功能
        function setupViewToggle() {
            // const toggleButtons = document.querySelectorAll('.btn-toggle');
            const toggleButtons = document.querySelectorAll('#view-toggle-InOut button');
            const chartContainer = document.getElementById('chart-container-InOut');
            const tableContainer = document.getElementById('table-container-InOut');

            toggleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 更新按钮状态
                    toggleButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');

                    // 切换视图
                    const view = this.dataset.view;
                    if (view === 'chart') {
                        chartContainer.style.display = 'block';
                        tableContainer.style.display = 'none';
                        chart.resize();
                    } else {
                        chartContainer.style.display = 'none';
                        tableContainer.style.display = 'block';
                    }
                });
            });
        }

        // 初始加载
        updateChart();
        setupViewToggle();

        // 响应式调整
        window.addEventListener('resize', function() {
            chart.resize();
        });
    });

    // 年度收益率柱图
    document.addEventListener('DOMContentLoaded', function() {
        const chartElement = document.getElementById('bar_net_value');
        if (!chartElement) {
            console.error('Element with id "bar_net_value" not found');
            return;
        }

        const chart = echarts.init(chartElement);
        const name_list = {{ name_list|safe }};
        const line_year_end_date_list = {{ line_year_end_date_list|safe }};
        const bar_year_end_date_list = {{ bar_year_end_date_list|safe }};
        const line_funds_net_value_list = {{ line_funds_net_value_list|safe }};
        const line_baseline_net_value_list = {{ line_baseline_net_value_list|safe }};
        const bar_funds_profit_rate_list = {{ bar_funds_profit_rate_list|safe }};
        const bar_baseline_profit_rate_list = {{ bar_baseline_profit_rate_list|safe }};

        // 更新图表
        function updateChart() {
            const option = {
                title: {
                    text: '',
                    subtext: '',
                    x: 'center'
                },
                legend: {
                },
                grid: {
                    top: '0%',
                    left: '3%',
                    right: '3%',
                    bottom: '0%',
                    containLabel: true
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    borderColor: '#ddd',
                    borderWidth: 1,
                    padding: [10, 15],
                    textStyle: {
                        color: '#333'
                    },
                    formatter: function(params) {
                        // 按系列类型分组
                        const barSeries = params.filter(p => p.seriesType === 'bar');
                        const lineSeries = params.filter(p => p.seriesType === 'line');

                        const year = params[0].name;
                        let html = `<div style="font-weight:bold;margin-bottom:8px;">${year}年</div>`;

                        // 显示柱状图数据（收益率）
                        if (barSeries.length > 0) {
                            barSeries.forEach(param => {
                                const color = param.color;
                                const value = param.value;
                                const seriesName = param.seriesName;
                                html += `
                                    <div style="display:flex;align-items:center;">
                                        <span class="icon-rect" style="background:${color};"></span>
                                        ${seriesName}：<span style="font-weight:bold;color:${color}">${value}%</span>
                                    </div>
                                `;
                            });
                        }

                        // 显示折线图数据（净值）
                        if (lineSeries.length > 0) {
                            lineSeries.forEach(param => {
                                const color = param.color;
                                const value = param.value.toFixed(4);
                                const seriesName = param.seriesName;
                                html += `
                                    <div style="display:flex;align-items:center;">
                                        <span class="icon-circle" style="border: 2px solid ${color};"></span>
                                        ${seriesName}：<span style="font-weight:bold;color:${color}">${value}</span>
                                    </div>
                                `;
                            });
                        }

                        return html;
                    }
                },
                xAxis: [
                    // 第一个 X 轴（柱状图使用）
                    {
                        data: bar_year_end_date_list,
                        boundaryGap: true,
                        axisLabel: {
                            show: true,
                            interval: 'auto',
                            rotate: 45,
                            margin: 15,
                            textStyle: {
                                color: '#ccc'
                            }
                        },
                        axisLine: {
                            show: true,
                            lineStyle: {
                                color: '#ccc'
                            }
                        }
                    },
                    // 第二个 X 轴（折线图使用）
                    {
                        data: line_year_end_date_list,
                        boundaryGap: true,
                        axisLabel: {
                            show: true,
                            interval: 'auto',
                            rotate: 45,
                            margin: 15,
                            textStyle: {
                                color: '#333'
                            }
                        },
                        show: false,
                        axisLine: {
                            show: false,
                            lineStyle: {
                                color: '#ccc'
                            }
                        }
                    },
                ],
                yAxis: [
                    // 左侧 Y 轴（柱状图使用）
                    {
                        type: 'value',
                        position: 'left',
                        axisLabel: {
                            formatter: '{value}%'  // 收益率显示 % 符号
                        },
                        splitLine: {
                            show: true,
                            lineStyle: {
                                type: 'dashed',
                                color: '#eee'
                            }
                        },
                        axisLine: {
                            show: false,
                            lineStyle: {
                                color: '#ccc'
                            }
                        }
                    },
                    // 右侧 Y 轴（折线图使用）
                    {
                        type: 'value',
                        position: 'right',
                        alignTicks: true,
                        axisLabel: {
                            formatter: value => value.toFixed(2) // 净值不显示 % 符号
                        },
                        splitLine: {
                            show: true,
                            lineStyle: {
                                type: 'dashed',
                                color: '#eee'
                            }
                        },
                        axisLine: {
                            show: false,
                            lineStyle: {
                                color: '#ccc'
                            }
                        },
                        //offset: 15 // 将右侧Y轴向右偏移
                    }
                ],
                series: [
                    {
                        name: '收益率（' + name_list[0]+ '）',
                        type: 'bar',
                        data: bar_funds_profit_rate_list,
                        color: ['#1890ff'],
                        xAxisIndex: 0,
                        yAxisIndex: 0,
                        itemStyle: {
                            borderRadius: [2, 2, 2, 2]
                        },
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                borderRadius: [2, 2, 2, 2]
                            }
                        }
                    },
                    {
                        name: '收益率（' + name_list[1]+ '）',
                        type: 'bar',
                        data: bar_baseline_profit_rate_list,
                        color: ['#ee9945'],
                        xAxisIndex: 0,
                        yAxisIndex: 0,
                        itemStyle: {
                            borderRadius: [2, 2, 2, 2]
                        },
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                borderRadius: [2, 2, 2, 2]
                            }
                        }
                    },
                    {
                        name: '净值（' + name_list[0]+ '）',
                        data: line_funds_net_value_list,
                        type: 'line',
                        smooth: false,
                        itemStyle: {
                            color: '#1890ff'
                        },
                        xAxisIndex: 1,
                        yAxisIndex: 1
                    },
                    {
                        name: '净值（' + name_list[1]+ '）',
                        data: line_baseline_net_value_list,
                        type: 'line',
                        smooth: false,
                        itemStyle: {
                            color: '#ee9945'
                        },
                        xAxisIndex: 1,
                        yAxisIndex: 1
                    }
                ]
            };
            chart.setOption(option, true);
        }

        // 初始加载
        updateChart();
        window.addEventListener('resize', () => chart.resize());
    });

    // 年化收益率折线图
    document.addEventListener('DOMContentLoaded', function() {
        const chart = echarts.init(document.getElementById('line_annualized_profit_rate'));
        const name_list = {{ name_list|safe }};
        const year_end_date_list = {{ year_end_date_list|safe }};
        const funds_annualized_profit_rate_list = {{ funds_annualized_profit_rate_list|safe }};
        const baseline_annualized_profit_rate_list = {{ baseline_annualized_profit_rate_list|safe }};

        //let currentRange = 'currentYear';

        // 更新图表
        function updateChart() {
            const option = {
            title: {
                text: '',
                subtext: '',
                x: 'center'
            },
            tooltip: {
                trigger: 'axis',

                formatter: function (params) {
                    const name = params[0].name;
                    let tooltip = `<div style="font-weight:bold;margin-bottom:8px;">${name}年</div>`;
                    params.forEach(param => {
                        const color = param.color;
                        const seriesName = param.seriesName;
                        const value = param.value.toFixed(2);
                        tooltip += `<div style="display:flex;align-items:center;">
                                <span class="icon-rect" style="background:${color};"></span>
                                ${seriesName}：<span style="font-weight:bold;color:${color}">${value}%</span>
                            </div>`;
                    });
                    return tooltip;
                }
            },
            legend: {
            },
            grid: {
                top: '10%',
                left: '3%',
                right: '5%',
                bottom: '0%',
                containLabel: true
            },
            xAxis: {
                //name: '年份',
                type: 'category',
                boundaryGap: false,
                data: year_end_date_list,
                axisLabel: { // 坐标轴文本标签，详见axis.axisLabel
                    show: true,
                    interval: 'auto',
                    rotate: 45,
                    margin: 15,
                    // formatter: null,
                    textStyle: { // 其余属性默认使用全局文本样式，详见TEXTSTYLE
                        color: '#ccc'
                    }
                },
                axisLine: {
                    lineStyle: {
                        color: '#ccc'
                    }
                }
            },
            yAxis: {
                //name: '净值',
                type: 'value',
                //min:0, // 配置 Y 轴刻度最小值
                //max:line_data['max_net_value'],  // 配置 Y 轴刻度最大值
                //splitNumber:7,  // 配置 Y 轴数值间隔
                axisLabel: {
                    formatter: (value) => `${value.toFixed(2)}%`
                },
                splitLine: {
                    show: true,
                    lineStyle: {
                        type: 'dashed',
                        color: '#eee'
                    }
                },
                axisLine: {
                    show: false,
                    lineStyle: {
                        color: '#ccc'
                    }
                }
            },
            series: [ // 多组折线图数据
                {
                    //name: '人民币账户',
                    name: name_list[0],
                    data: funds_annualized_profit_rate_list,
                    type: 'line',
                    smooth: true,
                    itemStyle: {
                        color: '#1890ff'
                    }
                },

                {
                    //name: '沪深300全收益指数',
                    name: name_list[1],
                    data: baseline_annualized_profit_rate_list,
                    type: 'line',
                    smooth: true,
                    itemStyle: {
                        color: '#ee9945'
                    }
                }
            ],
            color: ['#1890ff', '#ee9945']
        };
            chart.setOption(option, true);
        }

        // 初始加载
        updateChart();
        window.addEventListener('resize', () => chart.resize());
    });

    </script>

{% endblock %}

