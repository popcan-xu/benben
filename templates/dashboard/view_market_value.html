<!DOCTYPE html>
{% extends 'dashboard/base_dashboard.html' %}
{% load static %} <!-- 添加static标签加载 -->
{% load myfilters%}

{% block extra_css %}
    <!-- 引用外部CSS文件 -->
    <link href="{% static 'stock/css/card.css' %}" rel="stylesheet">
{% endblock %}


{% block page_content %}
    <div class="container-fluid">
        <!-- Page Heading -->
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <div class="col-xl-4" style="text-align:left">
                <h1 class="h3 mb-0 font-weight-bold text-gray-700">市值</h1>
            </div>
            <div class="col-xl-4" style="text-align:center"></div>
            <div class="col-xl-4" style="text-align:right">
                港元汇率：{{ rate.HKD|floatformat:4 }}，美元汇率：{{ rate.USD|floatformat:4 }}
            </div>
        </div>

        <!-- Content Card Row -->
        <div class="row">
            {% for key in currency_dict %}
                <div class="col-xl-4 col-md-6 mb-4">
                    <div class="card shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="h6 font-weight-bold text-primary text-uppercase mb-1">
                                        <a href="/benben/view_market_value_details/{{ key|safe }}" style="color: inherit; text-decoration: none;">{{ currency_dict|get_index:key|get_index:'name'|safe }}账户</a>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <div class="metric-label">
                                        <a href="/benben/view_market_value_details/{{ key|safe }}" style="color: inherit; text-decoration: none;">详情 ></a>
                                    </div>
                                </div>
                            </div>
                            <!-- Divider -->
                            <h3>&nbsp;</h3>
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
    {#                                <div class="h6 mb-0 text-gray-500">持仓市值（元）</div>#}
    {#                                <div class="h3 mb-0 text-gray-800">{{ value_dict|get_index:key|floatformat:0 }}</div>#}
                                    <div class="metric-label">持仓市值</div>
                                    <div class="metric-value">
                                        <span>{{ value_dict|get_index:key|floatformat:0 }}</span>
                                        <span class="metric-unit">元</span>
                                    </div>
                                </div>
                                <div class="col mr-2">
    {#                                <div class="h6 mb-0 text-gray-500">仓位（%）</div>#}
    {#                                <div class="h3 mb-0 text-gray-800">{{ position_percent_dict|get_index:key|percent }}</div>#}
                                    <div class="metric-label">仓位</div>
                                    <div class="metric-value">
                                        <span>{{ position_percent_dict|get_index:key|percent }}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}

        </div>

        <div class="row">
            <!-- 市值分布图 -->
            <div class="col-xl-4 col-lg-4">
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between" style="height: 60px;">
                        <h6 class="m-0 font-weight-bold text-primary">市值分布</h6>
                    </div>
                    <div class="chart-container" id="marketValueDistributionChart" style="width:100%; height:350px; display:block;"></div>
                    <div class="card-footer bg-white text-muted small d-flex justify-content-between">
                        数据更新于：{{ updating_time|date:'Y-m-d H:i:s' }}
                        <span></span>
                    </div>
                </div>
            </div>

            <!-- 市值列表 -->
            <div class="col-xl-8 col-lg-8 d-flex">
                <div class="card shadow mb-4 w-100 d-flex flex-column">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between" style="height: 60px;">
                        <h6 class="m-0 font-weight-bold text-primary">市值列表</h6>
                    </div>
                    <div class="card-body" style="position: relative; flex-grow: 1; min-height: 0;">
                        <div class="scroll-area">
                            <!-- 市值列表 -->
                            <div id="marketvalueTable" class="h-100" style="display:block; overflow-y:auto;">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-condensed table-striped table-hover list_tab">
                                        <thead class="bg-gradient-secondary text-gray-100">
                                            <tr>
                                                <th>名称</th>
                                                <th>持仓市值</th>
                                                <th>单位</th>
                                                <th>仓位</th>
                                                <th>更新日期</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for key in currency_dict %}
                                                <tr>
                                                    <td>{{ currency_dict|get_index:key|get_index:'name'|safe }}账户</td>
                                                    <td>{{ value_dict|get_index:key|floatformat:0 }}</td>
                                                    <td>{{ currency_dict|get_index:key|get_index:'code'|safe }}</td>
                                                    <td>{{ position_percent_dict|get_index:key|percent }}<span style="color:{{ i.3 }}">%</span></td>
                                                    <td>{{ current_date|date:'Y-m-d' }}</td>
                                                    <td><a href="/benben/view_market_value_details/{{ key|safe }}" style="color: inherit; text-decoration: none;">详情</a></td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-muted small d-flex justify-content-between">
                        数据更新于：{{ updating_time|date:'Y-m-d H:i:s' }}
                        <span></span>
                    </div>
                </div>
            </div>

        </div>

        <div class="row">
            <!-- 持仓列表 -->
            <div class="col-xl-12 col-lg-12 d-flex">
                <div class="card shadow mb-4 w-100 d-flex flex-column">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between" style="height: 60px;">
                        <h6 class="m-0 font-weight-bold text-primary" id="dataListTitle">持仓列表</h6>
                        <div class="btn-group" id="dataListSwitch">
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary active"
                                data-range="cny"
                                style="font-size: 12px !important; padding: 0.25rem 0.75rem;"
                            >人民币</button>
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary"
                                data-range="hkd"
                                style="font-size: 12px !important; padding: 0.25rem 0.75rem;"
                            >港元</button>
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary"
                                data-range="usd"
                                style="font-size: 12px !important; padding: 0.25rem 0.75rem;"
                            >美元</button>
                        </div>
                    </div>
                    <div class="card-body" style="position: relative; flex-grow: 1; min-height: 0;">
                        <div class="scroll-area">
                            <!-- 人民币 -->
                            <div id="cnyTable" class="h-100" style="display:block; overflow-y:auto;">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-condensed table-striped table-hover list_tab">
                                        <thead class="bg-gradient-secondary text-gray-100">
                                            <tr>
                                                <th>股票/代码</th>
                                                <th>价格</th>
                                                <th>涨跌幅</th>
                                                <th>持仓数量（股）</th>
                                                <th>金额（{{ currency_dict|get_index:1|get_index:'code'|safe }}）</th>
                                                <th>百分比</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for i in content_CNY %}
                                                <tr>
                                                    <td><a href="/benben/view_stock_details/{{ i.7|safe }}" style="color: inherit; text-decoration: none;">{{ i.0|stringformat:"s" }}</a></td>
                                                    <td style="text-align: right">{{ i.1|floatformat:3 }}</td>
                                                    <td style="text-align: right">{{ i.2|value_display:"percent" }}<span style="color:{{ i.3 }}">%</span></td>
                                                    <td style="text-align: right">{{ i.4|floatformat:0 }}</td>
                                                    <td style="text-align: right">{{ i.5|floatformat:0 }}</td>
                                                    <td style="text-align: right">{{ i.6 }}</td>
                                                </tr>
                                            {% endfor %}
                                            <tr>
                                                <td colspan="4"><b>合计</b>（股票数量：{{ content_CNY|length }}）</td>
                                                <td style="text-align: right"><b>{{ amount_sum_CNY|floatformat:0 }}</b></td>
                                                <td style="text-align: right"><b>100.00%</b></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- 港元 -->
                            <div id="hkdTable" class="h-100" style="display:none; overflow-y:auto;">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-condensed table-striped table-hover list_tab">
                                        <thead class="bg-gradient-secondary text-gray-100">
                                            <tr>
                                                <th>股票/代码</th>
                                                <th>价格</th>
                                                <th>涨跌幅</th>
                                                <th>持仓数量（股）</th>
                                                <th>金额（{{ currency_dict|get_index:2|get_index:'code'|safe }}）</th>
                                                <th>百分比</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for i in content_HKD %}
                                                <tr>
                                                    <td><a href="/benben/view_stock_details/{{ i.7|safe }}" style="color: inherit; text-decoration: none;">{{ i.0|stringformat:"s" }}</a></td>
                                                    <td style="text-align: right">{{ i.1|floatformat:3 }}</td>
    {#                                                <td style="text-align: right; color:{{ i.3 }}">{{ i.2 }}</td>#}
                                                    <td style="text-align: right">{{ i.2|value_display:"percent" }}<span style="color:{{ i.3 }}">%</span></td>
                                                    <td style="text-align: right">{{ i.4|floatformat:0 }}</td>
                                                    <td style="text-align: right">{{ i.5|floatformat:0 }}</td>
                                                    <td style="text-align: right">{{ i.6 }}</td>
                                                </tr>
                                            {% endfor %}
                                            <tr>
                                                <td><b>合计</b>（股票数量：{{ content_HKD|length }}）</td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td style="text-align: right"><b>{{ amount_sum_HKD|floatformat:0 }}</b></td>
                                                <td style="text-align: right"><b>100.00%</b></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>


                            <!-- 美元 -->
                            <div id="usdTable" class="h-100" style="display:none; overflow-y:auto;">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-condensed table-striped table-hover list_tab">
                                        <thead class="bg-gradient-secondary text-gray-100">
                                            <tr>
                                                <th>股票/代码</th>
                                                <th>价格</th>
                                                <th>涨跌幅</th>
                                                <th>持仓数量（股）</th>
                                                <th>金额（{{ currency_dict|get_index:3|get_index:'code'|safe }}）</th>
                                                <th>百分比</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for i in content_USD %}
                                                <tr>
                                                    <td><a href="/benben/view_stock_details/{{ i.7|safe }}" style="color: inherit; text-decoration: none;">{{ i.0|stringformat:"s" }}</a></td>
                                                    <td style="text-align: right">{{ i.1|floatformat:3 }}</td>
    {#                                                <td style="text-align: right; color:{{ i.3 }}">{{ i.2 }}</td>#}
                                                    <td style="text-align: right">{{ i.2|value_display:"percent" }}<span style="color:{{ i.3 }}">%</span></td>
                                                    <td style="text-align: right">{{ i.4|floatformat:0 }}</td>
                                                    <td style="text-align: right">{{ i.5|floatformat:0 }}</td>
                                                    <td style="text-align: right">{{ i.6 }}</td>
                                                </tr>
                                            {% endfor %}
                                            <tr>
                                                <td><b>合计</b>（股票数量：{{ content_USD|length }}）</td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td style="text-align: right"><b>{{ amount_sum_USD|floatformat:0 }}</b></td>
                                                <td style="text-align: right"><b>100.00%</b></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-muted small d-flex justify-content-between">
                        数据更新于：{{ updating_time|date:'Y-m-d H:i:s' }}
                        <span></span>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <script>
        // 持仓列表
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const titleElement = document.getElementById('dataListTitle');
            const cnyTable = document.getElementById('cnyTable');
            const hkdTable = document.getElementById('hkdTable');
            const usdTable = document.getElementById('usdTable');

            // 设置激活按钮样式
            function setActiveButton(activeRange) {
                const buttons = document.querySelectorAll('#dataListSwitch button');
                buttons.forEach(button => {
                    button.classList.remove('active');
                    if (button.dataset.range === activeRange) {
                        button.classList.add('active');
                    }
                });

                // 更新卡片标题
                titleElement.innerHTML = `${
                    activeRange === 'cny' ? '人民币持仓' :
                    activeRange === 'hkd' ? '港元持仓' :
                    '美元持仓'
                }`;
            }

            // 显示指定表格
            function showTable(range) {
                cnyTable.style.display = range === 'cny' ? 'block' : 'none';
                hkdTable.style.display = range === 'hkd' ? 'block' : 'none';
                usdTable.style.display = range === 'usd' ? 'block' : 'none';
                setActiveButton(range);
            }

            // 初始状态
            showTable('cny');

            // 添加切换按钮事件
            document.querySelectorAll('#dataListSwitch button').forEach(button => {
                button.addEventListener('click', function() {
                    showTable(this.dataset.range);
                });
            });

        });

        // 市值分布图
        document.addEventListener('DOMContentLoaded', function() {
            const chart = echarts.init(document.getElementById('marketValueDistributionChart'));
            const chartData = {{ value_dict_toCNY|safe }};

            function updateChart() {
                const option = {
                    tooltip: {
                        trigger: 'item',
                        borderColor: 'transparent', // 设置边框颜色为透明
                        formatter: function (params) { // params 是一个对象，包含了当前数据项的所有信息
                            return `<div style="font-weight:bold;margin-bottom:8px;">${params.name}</div>
                                    <div style="display:flex;align-items:center;">
                                        <span style="display:inline-block;width:12px;height:12px;background:${params.color};margin-right:8px;"></span>
                                        ${params.seriesName}：<span style="font-weight:bold;color:${params.color}">￥${params.data.value}万</span>
                                    </div>
                                    <div style="display:flex;align-items:center;">
                                        <span style="display:inline-block;width:12px;height:12px;background:${params.color};margin-right:8px;"></span>
                                        百分比：<span style="font-weight:bold;color:${params.color}">${params.percent}%</span>
                                    </div>`;
                        }
                    },
                    legend: {
                        orient: 'vertical',
                        right: 60,
                        top: 'center',
                        textStyle: {
                            fontSize: 12
                        }
                    },
                    series: [{
                        name: '市值',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        center: ['40%', '50%'],
                        avoidLabelOverlap: false,
                        itemStyle: {
                            borderRadius: 10,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                            show: false,
                            position: 'center'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: 18,
                                fontWeight: 'bold'
                            }
                        },
                        labelLine: {
                            show: false
                        },
                        data: [
                            { value: (chartData[1]/10000).toFixed(2), name: '人民币账户', itemStyle: { color: '#4c6ef5' } },
                            { value: (chartData[2]/10000).toFixed(2), name: '港元账户', itemStyle: { color: '#ff922b' } },
                            { value: (chartData[3]/10000).toFixed(2), name: '美元账户', itemStyle: { color: '#40c057' } }
                        ]
                    }]
                };
                chart.setOption(option, true);
            }

            // 初始加载
            updateChart();
            window.addEventListener('resize', () => chart.resize());
        });

    </script>

{% endblock %}