<!--资产变化日历-->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>资产变化日历</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        @media (max-width: 768px) {
            #viewSwitch .btn {
                padding: 0.25rem 0.5rem; /* 减小按钮内边距 */
                font-size: 0.875rem; /* 减小字体大小 */
            }
            #prevBtn,
            #nextBtn {
                background-color: transparent; /* 透明背景 */
                border: none; /* 移除边框 */
                padding: 5px; /* 调整内边距 */
            }

            #prevBtn:hover,
            #nextBtn:hover {
                background-color: transparent; /* 保持透明背景 */
                box-shadow: none; /* 移除悬停时的阴影 */
            }

            .text-center {
                font-size: 0.875rem; /* 减小年月显示的字体大小 */
            }

            .row.align-items-center {
                gap: 5px; /* 减小元素之间的间距 */
            }
        }

        /* 保持原有样式不变 */
        .date-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        .month-grid {
            grid-template-columns: repeat(4, 1fr);
        }
        .day-cell, .month-cell {
            padding: 10px;
            text-align: center;
            border: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 14px;
            min-height: 80px;
            position: relative;
            transition: transform 0.2s;
            cursor: pointer;
        }
        .asset-value {
            margin-top: 5px;
            font-weight: bold;
            font-size: 12px;
        }
        .week-days {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        .week-day {
            background-color: #f8f9fa;
            padding: 10px;
            text-align: center;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .summary {
            margin-top: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }
        .current-day {
            background-color: #87bdd8 !important;
            color: #333 !important;
        }
        .positive {
            background-color: #ffe5e5 !important;
            color: #b30000 !important;
        }
        .negative {
            background-color: #e5ffe5 !important;
            color: #008000 !important;
        }
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.65;
        }
        .day-cell:hover, .month-cell:hover {
            transform: scale(1.05);
            z-index: 2;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center mb-4">
                    <div class="col-auto pr-0">
                        <!-- 年月视图切换按钮 -->
                        <div class="btn-group" id="viewSwitch">
                            <button class="btn btn-outline-primary active" data-type="month">月</button>
                            <button class="btn btn-outline-primary" data-type="year">年</button>
                        </div>
                    </div>
                    <div class="col d-flex justify-content-end">
                        <!-- 时间显示和按钮 -->
                        <div class="d-flex align-items-center">
                            <button class="btn" id="prevBtn">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="flex-grow-1 text-center px-1">
                                <span id="timeDisplay"></span>
                            </div>
                            <button class="btn" id="nextBtn">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="week-days" id="weekHeader">
                    <!--<div class="week-day">日</div>-->
                    <div class="week-day">一</div>
                    <div class="week-day">二</div>
                    <div class="week-day">三</div>
                    <div class="week-day">四</div>
                    <div class="week-day">五</div>
                    <!--<div class="week-day">六</div>-->
                </div>
                <div class="date-grid" id="calendarGrid"></div>
                <div class="summary" id="periodSummary"></div>
            </div>
        </div>
    </div>

    <script>
        // 每日资产变化数据
        const assetChanges = {
            "2024-10-15": 5000,
            "2024-10-20": -3000,
            "2024-11-05": 8000,
            "2024-11-18": -4500,
            "2024-12-10": 123456,
            "2025-01-08": -75123,
            "2025-02-14": 18000
        };

        // 初始化当前日期
        const today = new Date();
        let currentYear = today.getFullYear();
        let currentMonth = today.getMonth();
        let currentView = 'month';

        function formatAmount(amount) {
            const isNegative = amount < 0;
            const absAmount = Math.abs(amount);
            let formatted = absAmount >= 10000
                ? `${(absAmount/10000).toFixed(2)}万`
                : absAmount.toLocaleString();
            return `${isNegative ? '-' : ''}${formatted}`;
        }

        function getMonthlyTotal(year, month) {
            const monthKey = `${year}-${String(month+1).padStart(2,'0')}`;
            return Object.entries(assetChanges)
                .filter(([date]) => date.startsWith(monthKey))
                .reduce((sum, [_, amount]) => sum + amount, 0);
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            if(currentView === 'month') {
                renderMonthView();
            } else {
                renderYearView();
            }

            updateNavigation();
            updateSummary();
        }

        function renderMonthView() {
            const grid = document.getElementById('calendarGrid');
            grid.className = 'date-grid';
            document.getElementById('weekHeader').style.display = 'grid';

            const dates = getDaysOfMonth(currentYear, currentMonth);
            dates.forEach(date => {
                const cell = document.createElement('div');
                cell.className = 'day-cell';

                if(date.getMonth() === currentMonth) {
                    const dateString = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
                    const dailyChange = assetChanges[dateString] || 0;

                    if(dailyChange > 0) {
                        cell.classList.add('positive');
                    } else if(dailyChange < 0) {
                        cell.classList.add('negative');
                    }

                    cell.textContent = date.getDate();

                    const valueSpan = document.createElement('span');
                    valueSpan.className = 'asset-value';
                    valueSpan.textContent = formatAmount(dailyChange);
                    cell.appendChild(valueSpan);

                    if(date.toDateString() === today.toDateString()) {
                        cell.classList.add('current-day');
                    }
                } else {
                    cell.classList.add('bg-light', 'text-muted');
                    cell.textContent = ''; // 非当前月日期显示为空
                }

                grid.appendChild(cell);
            });

            document.getElementById('timeDisplay').textContent =
                `${currentYear}年 ${currentMonth + 1}月`;
        }

        function renderYearView() {
            const grid = document.getElementById('calendarGrid');
            grid.className = 'date-grid month-grid';
            document.getElementById('weekHeader').style.display = 'none';

            const today = new Date(); // 获取当前日期
            const currentActualYear = today.getFullYear();
            const currentActualMonth = today.getMonth();

            for(let month = 0; month < 12; month++) {
                const cell = document.createElement('div');
                cell.className = 'month-cell';
                cell.dataset.year = currentYear;
                cell.dataset.month = month;

                const monthlyTotal = getMonthlyTotal(currentYear, month);
                if(monthlyTotal > 0) {
                    cell.classList.add('positive');
                } else if(monthlyTotal < 0) {
                    cell.classList.add('negative');
                }

                cell.textContent = `${month + 1}月`;

                const valueSpan = document.createElement('span');
                valueSpan.className = 'asset-value';
                valueSpan.textContent = formatAmount(monthlyTotal);
                cell.appendChild(valueSpan);

                // 判断是否为当前年份的未来月份
                if (currentYear === currentActualYear && month > currentActualMonth) {
                    // 禁用点击事件
                    cell.style.cursor = 'not-allowed';
                    cell.style.opacity = 0.5;
                    cell.style.userSelect = 'none';
                    // 移除悬停效果
                    cell.classList.remove('hover-effect');
                } else {
                    // 允许点击
                    cell.style.cursor = 'pointer';
                    cell.style.opacity = 1;
                    cell.style.userSelect = 'text';
                    cell.addEventListener('click', handleMonthClick);
                }

                grid.appendChild(cell);
            }

            document.getElementById('timeDisplay').textContent = `${currentYear}年`;
        }

        function handleMonthClick(event) {
            const cell = event.currentTarget;
            currentYear = parseInt(cell.dataset.year);
            currentMonth = parseInt(cell.dataset.month);
            currentView = 'month';

            // 手动更新视图切换按钮状态
            document.querySelectorAll('#viewSwitch button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === 'month');
            });

            renderCalendar();
        }

        function updateSummary() {
            let total = 0;

            if(currentView === 'month') {
                total = getMonthlyTotal(currentYear, currentMonth);
            } else {
                for(let m = 0; m < 12; m++) {
                    total += getMonthlyTotal(currentYear, m);
                }
            }

            document.getElementById('periodSummary').textContent =
                `${currentView === 'month' ? '本月' : '本年'}资产变化汇总：${formatAmount(total)}`;
        }

        function updateNavigation() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if(currentView === 'month') {
                //prevBtn.textContent = '上一月';
                //nextBtn.textContent = '下一月';
                prevBtn.title = '上一月';
                nextBtn.title = '下一月';
                const isCurrentMonth = currentYear === today.getFullYear() &&
                                    currentMonth === today.getMonth();
                nextBtn.disabled = isCurrentMonth;
            } else {
                //prevBtn.textContent = '上一年';
                //nextBtn.textContent = '下一年';
                prevBtn.title = '上一年';
                nextBtn.title = '下一年';
                nextBtn.disabled = currentYear >= today.getFullYear();
            }
        }

        function getDaysOfMonth(year, month) {
            const firstDay = new Date(year, month, 1);
            const startDay = firstDay.getDay(); // 直接使用getDay()的值
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dates = [];

            // 填充空白日期（周日）
            for(let i = 0; i < startDay; i++) {
                dates.push(new Date(year, month, -i));
            }

            // 生成当月日期（从周日开始）
            for(let i = 1; i <= daysInMonth; i++) {
                dates.push(new Date(year, month, i));
            }

            // 补全至7的倍数
            while(dates.length % 7 !== 0) {
                dates.push(new Date(year, month + 1, dates.length % 7 + 1));
            }

            return dates;
        }


// 修改后的 getDaysOfMonth 函数
function getDaysOfMonth(year, month) {
    const firstDay = new Date(year, month, 1);
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const dates = [];

    // 计算需要补全的前置工作日
    let prependDays = 0;
    if (firstDay.getDay() !== 0 && firstDay.getDay() !== 6) {
        prependDays = firstDay.getDay() - 1;
    }

    // 生成前置日期（上月）
    for (let i = prependDays; i > 0; i--) {
        dates.push(new Date(year, month, 1 - i));
    }

    // 生成当前月工作日
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        if (date.getDay() !== 0 && date.getDay() !== 6) {
            dates.push(date);
        }
    }

    // 补全后续日期（下月）
    const total = dates.length;
    const remainder = total % 5;
    const appendDays = remainder === 0 ? 0 : 5 - remainder;

    let nextMonthDay = 1;
    let appended = 0;
    while (appended < appendDays) {
        const date = new Date(year, month + 1, nextMonthDay);
        if (date.getDay() !== 0 && date.getDay() !== 6) {
            dates.push(date);
            appended++;
        }
        nextMonthDay++;
    }

    return dates;
}


        function prevPeriod() {
                    if(currentView === 'month') {
                        currentMonth--;
                        if(currentMonth < 0) {
                            currentMonth = 11;
                            currentYear--;
                        }
                    } else {
                        currentYear--;
                    }
                    renderCalendar();
                }

        function nextPeriod() {
            if(currentView === 'month') {
                const nextDate = new Date(currentYear, currentMonth + 1);
                if(nextDate <= new Date(today.getFullYear(), today.getMonth() + 1)) {
                    currentMonth++;
                    if(currentMonth > 11) {
                        currentMonth = 0;
                        currentYear++;
                    }
                }
            } else {
                currentYear++;
            }
            renderCalendar();
        }

        // 事件监听
        document.getElementById('prevBtn').addEventListener('click', prevPeriod);
        document.getElementById('nextBtn').addEventListener('click', nextPeriod);

        document.querySelectorAll('#viewSwitch button').forEach(btn => {
            btn.addEventListener('click', function() {
                const newView = this.dataset.type;
                if(newView !== currentView) {
                    currentView = newView;
                    document.querySelectorAll('#viewSwitch button').forEach(b =>
                        b.classList.remove('active'));
                    this.classList.add('active');

                    if(currentView === 'year') {
                        // 保留当前年份
                    } else {
                        // 仅在主动切换视图时重置到当前年月
                        if(this.dataset.type === 'month') {
                            currentYear = today.getFullYear();
                            currentMonth = today.getMonth();
                        }
                    }
                    renderCalendar();
                }
            });
        });

        // 初始渲染
        renderCalendar();
    </script>
</body>
</html>

<!-- 加入资产变化率 -->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>资产变化日历</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        @media (max-width: 768px) {
            #viewSwitch .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.875rem;
            }
            #prevBtn,
            #nextBtn {
                background-color: transparent;
                border: none;
                padding: 5px;
            }
            #prevBtn:hover,
            #nextBtn:hover {
                background-color: transparent;
                box-shadow: none;
            }
            .text-center {
                font-size: 0.875rem;
            }
            .row.align-items-center {
                gap: 5px;
            }
        }

        .date-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        .month-grid {
            grid-template-columns: repeat(4, 1fr);
        }
        .day-cell, .month-cell {
            padding: 10px;
            text-align: center;
            border: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 14px;
            min-height: 80px;
            position: relative;
            transition: transform 0.2s;
            cursor: pointer;
        }
        .asset-value {
            margin-top: 5px;
            font-weight: bold;
            font-size: 12px;
        }
        .week-days {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        .week-day {
            background-color: #f8f9fa;
            padding: 10px;
            text-align: center;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .summary {
            margin-top: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }
        .current-day {
            background-color: #73a3de !important;
            color: #333 !important;
        }
        .positive {
            background-color: #ffe5e5 !important;
            color: #b30000 !important;
        }
        .negative {
            background-color: #e5ffe5 !important;
            color: #008000 !important;
        }
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.65;
        }
        .day-cell:hover, .month-cell:hover {
            transform: scale(1.05);
            z-index: 2;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center mb-4">
                    <div class="col-auto pr-0">
                        <div class="btn-group" id="viewSwitch">
                            <button class="btn btn-outline-primary active" data-type="month">月</button>
                            <button class="btn btn-outline-primary" data-type="year">年</button>
                        </div>
                    </div>
                    <div class="col d-flex justify-content-between">
                        <div class="d-flex align-items-center">
                            <button class="btn" id="prevBtn">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="flex-grow-1 text-center px-1">
                                <span id="timeDisplay"></span>
                            </div>
                            <button class="btn" id="nextBtn">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="btn-group" id="toggleSwitch">
                            <button class="btn btn-outline-primary active" data-type="value">资产变化值</button>
                            <button class="btn btn-outline-primary" data-type="rate">资产变化率</button>
                        </div>
                    </div>
                </div>
                <div class="week-days" id="weekHeader">
                    <div class="week-day">一</div>
                    <div class="week-day">二</div>
                    <div class="week-day">三</div>
                    <div class="week-day">四</div>
                    <div class="week-day">五</div>
                </div>
                <div class="date-grid" id="calendarGrid"></div>
                <div class="summary" id="periodSummary"></div>
            </div>
        </div>
    </div>

    <script>
        // 模拟数据（日期 -> 资产变化值和变化率）
        const assetChanges = {
            "2024-10-15": { value: 5000, rate: 0.05 },
            "2024-10-20": { value: -3000, rate: -0.03 },
            "2024-11-05": { value: 8000, rate: 0.08 },
            "2024-11-18": { value: -4500, rate: -0.045 },
            "2024-12-10": { value: 123456, rate: 0.12 },
            "2025-01-08": { value: -75123, rate: -0.075 },
            "2025-02-03": { value: 18000, rate: 0.02 },
            "2025-02-07": { value: 22000, rate: 0.025 },
            "2025-02-10": { value: -1500, rate: -0.015 }
        };

        const today = new Date();
        let currentYear = today.getFullYear();
        let currentMonth = today.getMonth();
        let currentView = 'month';
        let displayType = 'value';

        function formatAmount(amount) {
            const isNegative = amount < 0;
            const absAmount = Math.abs(amount);
            return absAmount >= 10000
                ? `${(absAmount/10000).toFixed(2)}万`
                : absAmount.toLocaleString();
        }

        function formatRate(rate) {
            return `${(rate * 100).toFixed(2)}%`;
        }

        function getMonthlyTotal(year, month) {
            const monthKey = `${year}-${String(month+1).padStart(2,'0')}`;
            return Object.entries(assetChanges)
                .filter(([date]) => date.startsWith(monthKey))
                .reduce((sum, [_, data]) => sum + data.value, 0);
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            if(currentView === 'month') {
                renderMonthView();
            } else {
                renderYearView();
            }

            updateNavigation();
            updateSummary();
        }

        function renderMonthView() {
            const grid = document.getElementById('calendarGrid');
            grid.className = 'date-grid';
            document.getElementById('weekHeader').style.display = 'grid';

            const dates = getDaysOfMonth(currentYear, currentMonth);
            dates.forEach(date => {
                const cell = document.createElement('div');
                cell.className = 'day-cell';

                if(date.getMonth() === currentMonth) {
                    const dateString = date.toISOString().split('T')[0];
                    const data = assetChanges[dateString] || { value: 0, rate: 0 };

                    if(data.value > 0) {
                        cell.classList.add('positive');
                    } else if(data.value < 0) {
                        cell.classList.add('negative');
                    }

                    cell.textContent = date.getDate();

                    const valueSpan = document.createElement('span');
                    valueSpan.className = 'asset-value';
                    valueSpan.textContent = displayType === 'value'
                        ? formatAmount(data.value)
                        : formatRate(data.rate);
                    cell.appendChild(valueSpan);

                    if(date.toDateString() === today.toDateString()) {
                        cell.classList.add('current-day');
                    }
                } else {
                    cell.classList.add('bg-light', 'text-muted');
                    cell.textContent = '';
                }

                grid.appendChild(cell);
            });

            document.getElementById('timeDisplay').textContent =
                `${currentYear}年 ${currentMonth + 1}月`;
        }

        function renderYearView() {
            const grid = document.getElementById('calendarGrid');
            grid.className = 'date-grid month-grid';
            document.getElementById('weekHeader').style.display = 'none';

            const today = new Date();
            const currentActualYear = today.getFullYear();
            const currentActualMonth = today.getMonth();

            for(let month = 0; month < 12; month++) {
                const cell = document.createElement('div');
                cell.className = 'month-cell';
                cell.dataset.year = currentYear;
                cell.dataset.month = month;

                const monthlyTotal = getMonthlyTotal(currentYear, month);
                if(monthlyTotal > 0) {
                    cell.classList.add('positive');
                } else if(monthlyTotal < 0) {
                    cell.classList.add('negative');
                }

                cell.textContent = `${month + 1}月`;

                const valueSpan = document.createElement('span');
                valueSpan.className = 'asset-value';
                valueSpan.textContent = formatAmount(monthlyTotal);
                cell.appendChild(valueSpan);

                if (currentYear === currentActualYear && month > currentActualMonth) {
                    cell.style.cursor = 'not-allowed';
                    cell.style.opacity = 0.5;
                    cell.style.userSelect = 'none';
                    cell.classList.remove('hover-effect');
                } else {
                    cell.style.cursor = 'pointer';
                    cell.style.opacity = 1;
                    cell.style.userSelect = 'text';
                    cell.addEventListener('click', handleMonthClick);
                }

                grid.appendChild(cell);
            }

            document.getElementById('timeDisplay').textContent = `${currentYear}年`;
        }

        function handleMonthClick(event) {
            const cell = event.currentTarget;
            currentYear = parseInt(cell.dataset.year);
            currentMonth = parseInt(cell.dataset.month);
            currentView = 'month';

            document.querySelectorAll('#viewSwitch button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === 'month');
            });

            renderCalendar();
        }

        function updateSummary() {
            let total = 0;

            if(currentView === 'month') {
                total = getMonthlyTotal(currentYear, currentMonth);
            } else {
                for(let m = 0; m < 12; m++) {
                    total += getMonthlyTotal(currentYear, m);
                }
            }

            document.getElementById('periodSummary').textContent =
                `${currentView === 'month' ? '本月' : '本年'}资产变化汇总：${formatAmount(total)}`;
        }

        function updateNavigation() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if(currentView === 'month') {
                prevBtn.title = '上一月';
                nextBtn.title = '下一月';
                const isCurrentMonth = currentYear === today.getFullYear() &&
                                    currentMonth === today.getMonth();
                nextBtn.disabled = isCurrentMonth;
            } else {
                prevBtn.title = '上一年';
                nextBtn.title = '下一年';
                nextBtn.disabled = currentYear >= today.getFullYear();
            }
        }

        function getDaysOfMonth(year, month) {
            const firstDay = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dates = [];

            // 计算需要补全的前置工作日
            let prependDays = 0;
            if (firstDay.getDay() !== 0 && firstDay.getDay() !== 6) {
                prependDays = firstDay.getDay() - 1;
            }

            // 生成前置日期（上月）
            for (let i = prependDays; i > 0; i--) {
                dates.push(new Date(year, month, 1 - i));
            }

            // 生成当前月工作日
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                if (date.getDay() !== 0 && date.getDay() !== 6) {
                    dates.push(date);
                }
            }

            // 补全后续日期（下月）
            const total = dates.length;
            const remainder = total % 5;
            const appendDays = remainder === 0 ? 0 : 5 - remainder;

            let nextMonthDay = 1;
            let appended = 0;
            while (appended < appendDays) {
                const date = new Date(year, month + 1, nextMonthDay);
                if (date.getDay() !== 0 && date.getDay() !== 6) {
                    dates.push(date);
                    appended++;
                }
                nextMonthDay++;
            }

            return dates;
        }

        function prevPeriod() {
            if(currentView === 'month') {
                currentMonth--;
                if(currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
            } else {
                currentYear--;
            }
            renderCalendar();
        }

        function nextPeriod() {
            if(currentView === 'month') {
                const nextDate = new Date(currentYear, currentMonth + 1);
                if(nextDate <= new Date(today.getFullYear(), today.getMonth() + 1)) {
                    currentMonth++;
                    if(currentMonth > 11) {
                        currentMonth = 0;
                        currentYear++;
                    }
                }
            } else {
                currentYear++;
            }
            renderCalendar();
        }

        // 事件监听
        document.getElementById('prevBtn').addEventListener('click', prevPeriod);
        document.getElementById('nextBtn').addEventListener('click', nextPeriod);

        document.querySelectorAll('#viewSwitch button').forEach(btn => {
            btn.addEventListener('click', function() {
                const newView = this.dataset.type;
                if(newView !== currentView) {
                    currentView = newView;
                    document.querySelectorAll('#viewSwitch button').forEach(b =>
                        b.classList.remove('active'));
                    this.classList.add('active');

                    if(currentView === 'year') {
                        // 保留当前年份
                    } else {
                        if(this.dataset.type === 'month') {
                            currentYear = today.getFullYear();
                            currentMonth = today.getMonth();
                        }
                    }
                    renderCalendar();
                }
            });
        });

        document.querySelectorAll('#toggleSwitch button').forEach(btn => {
            btn.addEventListener('click', function() {
                const newType = this.dataset.type;
                if(newType !== displayType) {
                    displayType = newType;
                    document.querySelectorAll('#toggleSwitch button').forEach(b =>
                        b.classList.remove('active'));
                    this.classList.add('active');
                    renderCalendar();
                }
            });
        });

        // 初始渲染
        renderCalendar();
    </script>
</body>
</html>

<!-- 资产净值走势图 -->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>市值管理系统</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>

    <style>
        .chart-card {
            margin: 20px auto;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        #chart_net_value {
            height: 450px;
            width: 100%;
        }
        .time-switch {
            padding: 15px 0;
            border-top: 1px solid rgba(0,0,0,.125);
        }
/* 覆盖按钮组字体 */
.chart-card .btn-group .btn {
    font-size: 12px !important;
    padding: 0.25rem 0.75rem;
}

/* 移动端适配 */
@media (max-width: 768px) {
    .chart-card .btn-group .btn {
        font-size: 10px !important;
        padding: 0.2rem 0.5rem;
    }
}
    </style>
</head>
<body>
    <div class="col-xl-12 col-md-6 mb-4">
        <div class="card chart-card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">资产净值走势图</h5>
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-outline-primary active" data-range="currentYear">今年</button>
                    <button type="button" class="btn btn-sm btn-outline-primary" data-range="year">近一年</button>
                    <button type="button" class="btn btn-sm btn-outline-primary" data-range="all">记账以来</button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="container mt-4">
                    <div id="chart_net_value"></div>
                </div>
            </div>
            <div class="card-footer bg-white text-muted small">
                数据更新于：<span id="updateTime"></span>
            </div>
        </div>
    </div>
    <script>
    'use strict';

    document.addEventListener('DOMContentLoaded', function() {
        const chart1 = echarts.init(document.getElementById('chart_net_value'));
        const allData = {{ data|safe }};
        let currentRange = 'currentYear';

        // 更新时间显示
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('updateTime').textContent =
                now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
        }

        // 时间范围计算
        function getDateRange(range) {
            const now = new Date();
            const ranges = {
                all: new Date(0),
                year: new Date(now.getFullYear() - 1, now.getMonth(), now.getDate()),
                currentYear: new Date(now.getFullYear(), 0, 1)
            };
            return ranges[range] || ranges.all;
        }

        // 更新图表
        function updateChart(range) {
            const startDate = getDateRange(range);
            const filteredData = allData.filter(d => new Date(d.date) >= startDate);
            const option = {
                xAxis: {
                    type: 'time',
                    axisLabel: {
                        rotate: -35,
                        margin: 15,
                        interval: (index, timestamp) => {
                            const axis = chart1.getModel().getComponent('xAxis', 0).axis;
                            const [min, max] = axis.scale.getExtent();
                            const totalDays = (max - min) / (1000 * 3600 * 24);

                            if (totalDays <= 7) return index % 1 === 0;
                            if (totalDays <= 30) return index % 2 === 0;
                            return index % Math.ceil(totalDays/30) === 0;
                        },
                        formatter: function (value) {
                            const date = new Date(value);
                            // 处理闰年2月29日
                            if (date.getMonth() === 1 && date.getDate() === 29) {
                                return '02-29';
                            }
                            const rangeType = range;

                            if (rangeType === 'currentYear') {
                                const axis = chart1.getModel().getComponent('xAxis', 0).axis;
                                const [min, max] = axis.scale.getExtent();
                                const dayDiff = (max - min) / (1000 * 3600 * 24);

                                // 精确判断逻辑
                                if (dayDiff <= 60) { // 调整为60天阈值
                                    const month = (date.getMonth()+1).toString().padStart(2, '0');
                                    const day = date.getDate().toString().padStart(2, '0');
                                    return `${month}-${day}`;
                                }
                                return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}`;
                            }

                            if (rangeType === 'all') {
                                return `${date.getFullYear()}`;
                            }
                            return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}`;
                        }
                    },
                    axisTick: {
                        alignWithLabel: true
                    }
                },
                yAxis: {
                    type: 'value',
                    min: 'dataMin',
                    axisLabel: {
                        formatter: value => value.toFixed(2)
                    }
                },
                series: [{
                    data: filteredData.map(d => [
                        new Date(d.date).getTime(), // 转换为时间戳
                        d.value
                    ]),
                    //data: filteredData.map(d => [d.date, d.value]),
                    type: 'line',
                    smooth: true,
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(24,144,255,0.6)' },
                            { offset: 1, color: 'rgba(24,144,255,0.01)' }
                        ])
                    },
                    itemStyle: {
                        color: '#1890ff'
                    }
                }],
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        // 获取原始时间戳（或日期字符串）
                        const rawDate = params[0].axisValue;

                        // 创建日期对象（兼容时间戳和字符串）
                        const dateObj = new Date(typeof rawDate === 'number' ? rawDate : rawDate);

                        // 使用echarts内置格式化工具
                        const formattedDate = echarts.time.format(
                            dateObj,
                            '{yyyy}-{MM}-{dd}',
                            false
                        );

                        // 使用更友好的中文格式（示例：2024年03月01日）
                        // const formattedDate = `${dateObj.getFullYear()}年
                        //                     ${(dateObj.getMonth()+1).toString().padStart(2, '0')}月
                        //                     ${dateObj.getDate().toString().padStart(2, '0')}日`;

                        return `${formattedDate}<br/>
                                净值: ${params[0].data[1].toFixed(4)}`;
                    }
                }
            };
            chart1.setOption(option, true);
            updateTimestamp();
        }

        // 按钮事件
        document.querySelectorAll('[data-range]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-range]').forEach(b =>
                    b.classList.remove('active'));
                this.classList.add('active');
                updateChart(this.dataset.range);
            });
        });

        // 初始加载
        updateChart(currentRange);
        window.addEventListener('resize', () => {
            chart1.resize();
        });
    });

    //响应式调整：添加窗口resize监听，动态更新标签格式
    //window.addEventListener('resize', () => {
    //    chart1.resize();
    //    updateChart(currentRange); // 重新应用格式
    //});
    </script>
</body>
</html>

<!-- 净值折线图和增长率柱图 -->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>净值与增长率组合图</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <style>
        #mainChart {
            width: 100%;
            height: 600px;
            margin: 20px auto;
            border: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div id="mainChart"></div>

    <script>
    'use strict';
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化图表实例
        const chart = echarts.init(document.getElementById('mainChart'));

        // 模拟数据（可根据实际数据替换）
        const option = {
            title: {
                text: '年度净值与增长率分析',
                subtext: '数据来源：企业年报',
                left: 'center'
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                }
            },
            legend: {
                data: ['净值（万元）', '增长率'],
                top: 30
            },
            grid: {
                left: '10%',
                right: '10%',
                bottom: '15%'
            },
            xAxis: [{
                type: 'category',
                data: ['2018', '2019', '2020', '2021', '2022', '2023'], // 年份数据
                axisLabel: {
                    rotate: 45
                }
            }],
            yAxis: [
                { // 左侧Y轴（净值）
                    type: 'value',
                    name: '净值（万元）',
                    axisLabel: {
                        formatter: '{value}'
                    }
                },
                { // 右侧Y轴（增长率）
                    type: 'value',
                    name: '增长率',
                    axisLabel: {
                        formatter: '{value}%'
                    },
                    splitLine: {show: false}  // 隐藏辅助线
                }
            ],
            series: [
                { // 净值折线系列
                    name: '净值（万元）',
                    type: 'line',
                    smooth: true,
                    yAxisIndex: 0, // 绑定左侧Y轴
                    data: [120, 135, 165, 198, 210, 245],
                    itemStyle: {
                        color: '#1890ff' // 蓝色折线
                    },
                    lineStyle: {
                        width: 3
                    }
                },
                { // 增长率柱图系列
                    name: '增长率',
                    type: 'bar',
                    yAxisIndex: 1, // 绑定右侧Y轴
                    data: [12.5, 22.2, -18.3, 20.0, 15.8, 16.7],
                    itemStyle: {
                        color: '#52c41a', // 绿色柱图
                        borderRadius: [5, 5, 0, 0] // 顶部圆角
                    },
                    barWidth: '30%' // 柱宽设置
                }
            ]
        };

        chart.setOption(option);
        window.addEventListener('resize', () => chart.resize());
    });
    </script>
</body>
</html>

def is_weekday(date_obj):
    """判断是否为工作日（周一至周五）"""
    return date_obj.weekday() < 5  # 0-4为周一到周五


def generate_cumulative_positions():
    """工作日累计持仓生成（排除周六日）"""
    current_positions = {}  # 当前持仓状态 {(stock_id, currency): quantity}
    create_buffer = []  # 批量创建缓存
    update_buffer = []  # 批量更新缓存

    try:
        with transaction.atomic():
            # 阶段一：确定日期范围（最近2年）
            start_date = datetime.date(2007, 8, 16)
            end_date = timezone.now().date() + datetime.timedelta(days=1)
            #start_date = end_date - datetime.timedelta(days=730)

            # 生成排除周末的日期序列
            date_sequence = []
            current_day = start_date
            while current_day <= end_date:
                if is_weekday(current_day):
                    date_sequence.append(current_day)
                current_day += datetime.timedelta(days=1)

            # 阶段二：加载初始持仓（最后一个工作日的持仓）
            last_workday = historical_position.objects.aggregate(
                max_date=models.Max('date')
            )['max_date']

            if last_workday:
                initial_positions = historical_position.objects.filter(
                    date=last_workday
                ).values('stock_id', 'currency', 'quantity')

                for pos in initial_positions:
                    key = (pos['stock_id'], pos['currency'])
                    current_positions[key] = pos['quantity']

            # 阶段三：遍历所有工作日
            for current_date in date_sequence:
                # 获取当日交易净变动（只处理工作日）
                daily_trans = (
                    trade.objects.filter(trade_date=current_date)
                        .values('stock', 'settlement_currency')
                        .annotate(
                        net_qty=Sum(
                            Case(
                                When(trade_type=trade.BUY, then=F('trade_quantity')),
                                When(trade_type=trade.SELL, then=-F('trade_quantity')),
                                output_field=models.IntegerField()
                            )
                        )
                    )
                )

                # 处理当日有交易的持仓
                processed_keys = set()
                for trans in daily_trans:
                    stock_id = trans['stock']
                    currency = trans['settlement_currency']
                    net_qty = trans['net_qty'] or 0
                    key = (stock_id, currency)

                    current_qty = current_positions.get(key, 0)
                    new_qty = current_qty + net_qty
                    current_positions[key] = new_qty
                    processed_keys.add(key)

                # 处理当日无交易但需延续的持仓
                for key in list(current_positions.keys()):
                    if key not in processed_keys:
                        new_qty = current_positions[key]
                    else:
                        continue

                    # 检查记录是否存在
                    exists = historical_position.objects.filter(
                        date=current_date,
                        stock_id=key[0],
                        currency=key[1]
                    ).exists()

                    # 加入缓冲区
                    if exists:
                        update_buffer.append({
                            'date': current_date,
                            'stock_id': key[0],
                            'currency': key[1],
                            'quantity': new_qty
                        })
                    else:
                        create_buffer.append(
                            historical_position(
                                date=current_date,
                                stock_id=key[0],
                                currency=key[1],
                                quantity=new_qty
                            )
                        )

                # 批量操作（每300条执行一次）
                if len(create_buffer) >= 300:
                    historical_position.objects.bulk_create(create_buffer)
                    create_buffer = []

                if len(update_buffer) >= 300:
                    update_queries = [
                        models.When(
                            Q(date=item['date']) &
                            Q(stock_id=item['stock_id']) &
                            Q(currency=item['currency']),
                            then=models.Value(item['quantity'])
                        ) for item in update_buffer
                    ]
                    historical_position.objects.update(
                        quantity=Case(*update_queries, default=F('quantity'))
                    )
                    update_buffer = []

            # 处理剩余缓存
            if create_buffer:
                historical_position.objects.bulk_create(create_buffer)
            if update_buffer:
                update_queries = [
                    models.When(
                        Q(date=item['date']) &
                        Q(stock_id=item['stock_id']) &
                        Q(currency=item['currency']),
                        then=models.Value(item['quantity'])
                    ) for item in update_buffer
                ]
                historical_position.objects.update(
                    quantity=Case(*update_queries, default=F('quantity'))
                )

            return f"成功处理{len(date_sequence)}个工作日，新增{len(create_buffer)}条，更新{len(update_buffer)}条"

    except IntegrityError as e:
        logger.error(f"数据冲突: {str(e)}")
        conflict = historical_position.objects.filter(
            date=current_date,
            stock_id=key[0],
            currency=key[1]
        ).first()
        raise RuntimeError(f"唯一性冲突：日期{current_date} 股票{conflict.stock_id}") from e
    except Exception as e:
        logger.exception("持仓生成严重错误")
        raise RuntimeError(f"系统异常: {str(e)}") from e
