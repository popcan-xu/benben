<!DOCTYPE html>
{% extends 'dashboard/base_dashboard.html' %}
{% block page_content %}
<html lang="zh-CN">
    <head>
        <title>ä»»åŠ¡è¿›åº¦ç›‘æ§</title>
        <style>
        /* è¿›åº¦æ¡åŠ¨ç”» */
        .progress-bar {
            transition: width 0.5s ease-in-out !important;
        }

        /* çŠ¶æ€é¢œè‰² */
        .badge-success { background-color: #28a745; }
        .badge-danger { background-color: #dc3545; }
        .badge-warning { background-color: #ffc107; }
        .badge-info { background-color: #17a2b8; }

        .progress-bar-striped {
            background-image: linear-gradient(
                45deg,
                rgba(255, 255, 255, 0.15) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, 0.15) 50%,
                rgba(255, 255, 255, 0.15) 75%,
                transparent 75%,
                transparent
            );
            background-size: 1rem 1rem;
        }

        .progress-bar-animated {
            animation: progress-bar-stripes 1s linear infinite;
        }

        @keyframes progress-bar-stripes {
            from { background-position: 1rem 0; }
            to { background-position: 0 0; }
        }

        /* æ­¥éª¤åˆ—è¡¨æ ·å¼ */
        .active-step {
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
        }

        /*
        .completed-step {
            opacity: 0.7;
        }

        .completed-step .step-name {
            text-decoration: line-through;
        }
        */

        .step-item {
            transition: background-color 0.3s ease; /* æ·»åŠ è¿‡æ¸¡åŠ¨ç”» */
        }

        .active-step {
            background-color: #f8faff; /* æ›´æŸ”å’Œçš„å½“å‰æ­¥éª¤èƒŒæ™¯è‰² */
            border-left: 3px solid #007bff;
        }

        .status-badge {
            min-width: 80px;
            font-weight: normal;
            font-size: 0.9em;
        }

        .status-badge {
            min-width: 80px;
            font-weight: normal;
        }


        </style>
    </head>
    <body>
        <div class="col-xl-12 col-md-6 mb-4">
            <div class="card chart-card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">æ›´æ–°å†å²æŒä»“æ•°æ®</h5>
                </div>
                <div class="card-body p-3">
                    <!-- è¿›åº¦æ¡å®¹å™¨ -->
                    <div class="progress" style="height: 30px;">
                        <div id="progress-bar"
                             class="progress-bar progress-bar-striped"
                             role="progressbar"
                             style="width: 0%; transition: width 0.3s ease;">
                            <span id="progress-text">0%</span>
                        </div>
                    </div>
                    <!-- æ–°å¢è€—æ—¶æ˜¾ç¤º -->
                    <small class="text-muted mt-1">è€—æ—¶ï¼š<span id="duration-display">0.00</span></small>
                    <!-- æ­¥éª¤çŠ¶æ€åˆ—è¡¨ -->
                    <div class="mt-4">
                        <h5>æ‰§è¡Œæ­¥éª¤è¯¦æƒ…ï¼š</h5>
                        <ul id="step-list" class="list-group">
                            <!-- æ­¥éª¤å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </ul>
                    </div>

                </div>
            </div>
        </div>

        <script>

        // åˆå§‹åŒ–æ­¥éª¤åˆ—è¡¨
        const steps = [
            "ç”Ÿæˆå†å²æŒä»“",
            "è·å–å†å²æ”¶ç›˜ä»·",
            "è¡¥å…¨å†å²æ”¶ç›˜ä»·",
            "è·å–ä»Šæ—¥ä»·æ ¼",
            "è·å–å†å²æ±‡ç‡",
            "å¡«å……ç¼ºå¤±çš„å†å²æ±‡ç‡",
            "è®¡ç®—å¸‚åœºä»·å€¼",
            "è®¡ç®—å¹¶å¡«å……å†å²æ•°æ®"
        ];

        // åœ¨DOMåŠ è½½æ—¶åˆå§‹åŒ–æ­¥éª¤åˆ—è¡¨
        $(document).ready(function() {
            const $stepList = $('#step-list');
            steps.forEach((stepName, index) => {
                $stepList.append(`
                    <li class="list-group-item step-item" data-step="${index + 1}">
                        <span class="step-name">${stepName}</span> <!-- æ­¤å¤„ç›´æ¥å†™å…¥ -->
                        <span class="status-badge badge float-right"></span>
                        <small class="step-progress text-muted float-right mr-2">
                            (${index + 1}/${steps.length})
                        </small>
                    </li>
                `);
            });
            updateProgress();  // å¼€å§‹è½®è¯¢
        });

        function updateProgress() {
            $.ajax({
                url: "/benben/get_task_status/",
                success: function(data) {
                    // console.log("[å‰ç«¯] AJAX å“åº”æ•°æ®:", data);

                    // æ›´æ–°è¿›åº¦æ¡
                    const progress = (data.current_step / data.total_steps) * 100;
                    $('#progress-bar').css('width', progress + '%');
                    $('#progress-text').text(progress.toFixed(1) + '%');

                    // æ–°å¢ï¼šæ›´æ–°è€—æ—¶æ˜¾ç¤º
                    // $('#duration-display').text(data.duration.toFixed(2));
                    $('#duration-display').text(formatDuration(data.duration));

                    // æ›´æ–°æ­¥éª¤çŠ¶æ€
                    updateStepStatus(data);

                    // åŠ¨æ€è°ƒæ•´è¿›åº¦æ¡é¢œè‰²
                    updateProgressBarStyle(data.status, progress);

                    // æ ¹æ®ä»»åŠ¡çŠ¶æ€å†³å®šæ˜¯å¦ç»§ç»­è½®è¯¢
                    if (data.status === 'running') {
                        setTimeout(updateProgress, 500); // ä»»åŠ¡è¿›è¡Œä¸­ç»§ç»­è½®è¯¢
                    } else {
                        // ä»»åŠ¡å®Œæˆæˆ–å¤±è´¥æ—¶åœæ­¢è½®è¯¢
                        if (data.status === 'completed') {
                            $('.step-item:last .status-badge')
                                .removeClass('badge-primary')
                                .addClass('badge-success')
                                .html('âœ“ å®Œæˆ');
                        }
                        // å¯é€‰ï¼šæ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
                    }
                },
                error: function() {
                    // å¤„ç†é”™è¯¯æƒ…å†µï¼Œä¾‹å¦‚åœæ­¢è½®è¯¢
                    console.error("è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥");
                }
            });
        }

        function updateStepStatus(data) {
            //console.log("[å‰ç«¯] AJAX å“åº”æ•°æ®:", data);
            const $steps = $('.step-item');
            $steps.each(function(index) {
                const $step = $(this);
                const stepNumber = index + 1;

                // ä¸ä¿®æ”¹æ­¥éª¤åç§°ï¼ˆå·²åœ¨åˆå§‹åŒ–æ—¶ç»‘å®šï¼‰
                // ä»…æ›´æ–°çŠ¶æ€å¾½ç« å’Œæ ·å¼
                const $badge = $step.find('.status-badge');
                $badge.removeClass('badge-primary badge-success');

                if (stepNumber < data.current_step) {
                    $badge.addClass('badge-success').text('âœ“ å®Œæˆ');
                } else if (stepNumber === data.current_step) {
                    const isRunning = data.status === 'running';
                    $badge.addClass(isRunning ? 'badge-primary' : 'badge-success')
                          .text(isRunning ? 'ğŸ”„ æ‰§è¡Œä¸­' : 'âœ“ å®Œæˆ');
                }
            });
        }

        // è·å–çŠ¶æ€å¯¹åº”çš„CSSç±»
        function getStatusClass(status) {
            const map = {
                'running': 'badge-info',
                'completed': 'badge-success',
                'failed': 'badge-danger',
                'idle': 'badge-secondary'
            };
            return map[status] || 'badge-warning';
        }

        // åŠ¨æ€è°ƒæ•´è¿›åº¦æ¡æ ·å¼
        function updateProgressBarStyle(status, progress) {
            const $bar = $('#progress-bar');
            $bar.removeClass('bg-success bg-danger bg-info');

            // æ§åˆ¶æ¡çº¹åŠ¨ç”»
            if (status === 'running') {
                $bar.addClass('progress-bar-animated');
            } else {
                $bar.removeClass('progress-bar-animated');
            }

            if (status === 'completed') {
                $bar.addClass('bg-success');
            } else if (status === 'failed') {
                $bar.addClass('bg-danger');
/*
            } else if (progress >= 99) {
                $bar.addClass('bg-warning'); // æ¥è¿‘å®Œæˆæ—¶æ˜¾ç¤ºé»„è‰²
*/
            } else {
                $bar.addClass('bg-info');
            }

        }

        function formatDuration(seconds) {
            if (seconds < 60) {
                return seconds.toFixed(2) + "ç§’";
            }
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return minutes + "åˆ†" + remainingSeconds.toFixed(2) + "ç§’";
        }

        </script>

    </body>
</html>
{% endblock %}